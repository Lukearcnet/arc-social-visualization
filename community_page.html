<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Community - ARC Social Graph</title>
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --fg-primary: #ffffff;
            --fg-secondary: #cccccc;
            --fg-muted: #888888;
            --accent: #007bff;
            --accent-hover: #0056b3;
            --stroke: #333333;
            --radius: 8px;
            --radius-2: 4px;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--fg-primary);
            overflow: hidden;
            height: 100vh;
        }

        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* Community Page Styles */
        .community-page {
            background: var(--bg-primary);
            color: var(--fg-primary);
            min-height: 100vh;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .community-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
        }

        .community-header h1 {
            font-size: var(--text-3xl);
            font-weight: 600;
            color: var(--fg-primary);
        }

        .last-updated {
            font-size: var(--text-sm);
            color: var(--fg-muted);
        }

        /* Navigation Tabs */
        .community-nav {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            border-bottom: 1px solid var(--stroke);
        }

        .nav-tab {
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .nav-tab.active {
            color: var(--fg-primary);
            border-bottom-color: var(--accent);
        }

        .nav-tab:hover {
            color: var(--fg-primary);
        }

        /* Recap Cards */
        .recap-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .recap-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            padding: var(--space-4);
            text-align: center;
        }

        .recap-card h3 {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            margin-bottom: var(--space-2);
        }

        .recap-value {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--fg-primary);
        }

        /* Momentum Ring */
        .momentum-section {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-8);
        }

        .momentum-ring {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--accent) 0deg, var(--stroke) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring-progress {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring-text {
            text-align: center;
        }

        .streak-days {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--accent);
        }

        .streak-label {
            font-size: var(--text-xs);
            color: var(--fg-muted);
        }

        /* Leaderboard */
        .leaderboard-section {
            margin-bottom: var(--space-8);
        }

        .leaderboard-nav {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .leaderboard-tab {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-1);
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .leaderboard-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--stroke);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        /* Recommendations */
        .recommendations-section {
            margin-bottom: var(--space-8);
        }

        .recommendations-carousel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-4);
        }

        .recommendation-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            padding: var(--space-4);
        }

        .recommendation-card h4 {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .recommendation-scores {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .score-badge {
            padding: var(--space-1) var(--space-2);
            background: var(--accent);
            color: var(--bg-primary);
            border-radius: var(--radius-1);
            font-size: var(--text-xs);
            font-weight: 500;
        }

        .recommendation-actions {
            display: flex;
            gap: var(--space-2);
        }

        .action-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-primary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-1);
            color: var(--fg-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .action-btn.primary {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .community-page {
                padding: var(--space-2);
            }
            
            .recap-strip {
                grid-template-columns: 1fr;
            }
            
            .recommendations-carousel {
                grid-template-columns: 1fr;
            }
            
            .community-nav {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1;
                min-width: 0;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--accent);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--stroke);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-4);
        }

        .loading-state p {
            color: var(--fg-muted);
            font-size: var(--text-sm);
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="content-area">
            <div id="community-container" class="community-page">
                <!-- Header -->
                <div class="community-header">
                    <h1>Community</h1>
                    <div class="last-updated">Last updated at <span id="last-updated-time"></span></div>
                </div>

                <!-- Navigation Tabs -->
                <div class="community-nav">
                    <button class="nav-tab active" data-section="pulse">Weekly Pulse</button>
                    <button class="nav-tab" data-section="quests">Quests & Routes</button>
                    <button class="nav-tab" data-section="radar">Opportunity Radar</button>
                    <button class="nav-tab" data-section="health">Relationship Health</button>
                </div>

                <!-- Content Sections -->
                <div class="community-content">
                        <!-- Weekly Pulse Section -->
                        <div id="pulse-section" class="community-section active">
                            <!-- Loading State -->
                            <div id="loading-state" class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading your community data...</p>
                            </div>
                            
                            <!-- Content (hidden initially) -->
                            <div id="content-state" style="display: none;">
                                <!-- Recap Cards -->
                                <div class="recap-strip">
                                    <div class="recap-card">
                                        <h3>New Connections</h3>
                                        <div class="recap-value" id="new-connections-count">-</div>
                                    </div>
                                    <div class="recap-card">
                                        <h3>Network Growth</h3>
                                        <div class="recap-value" id="network-growth-count">-</div>
                                    </div>
                                    <div class="recap-card">
                                        <h3>Community Activity</h3>
                                        <div class="recap-value" id="community-activity-count">-</div>
                                    </div>
                                </div>

                        <!-- Momentum Ring -->
                        <div class="momentum-section">
                            <div class="momentum-ring">
                                <div class="ring-progress" id="weekly-goal-progress"></div>
                                <div class="ring-text">
                                    <div class="streak-days" id="current-streak">-</div>
                                    <div class="streak-label">day streak</div>
                                </div>
                            </div>
                        </div>

                        <!-- Leaderboard Tabs -->
                        <div class="leaderboard-section">
                            <div class="leaderboard-nav">
                                <button class="leaderboard-tab active" data-leaderboard="connectors">Top Connectors</button>
                                <button class="leaderboard-tab" data-leaderboard="reach">Expanding Reach</button>
                                <button class="leaderboard-tab" data-leaderboard="consistency">Consistency</button>
                            </div>
                            <div class="leaderboard-content" id="leaderboard-list"></div>
                        </div>

                        <!-- Recommendations -->
                        <div class="recommendations-section">
                            <h3>People You Should Meet</h3>
                            <div class="recommendations-carousel" id="recommendations-list"></div>
                        </div>
                    </div>

                    <!-- Other sections will be added here -->
                    <div id="quests-section" class="community-section" style="display: none;">
                        <h2>Quests & Routes</h2>
                        <p>Quest system coming soon...</p>
                    </div>

                    <div id="radar-section" class="community-section" style="display: none;">
                        <h2>Opportunity Radar</h2>
                        <p>Live activity radar coming soon...</p>
                    </div>

                    <div id="health-section" class="community-section" style="display: none;">
                        <h2>Relationship Health</h2>
                        <p>Relationship management coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Community Page JavaScript
        class CommunityPage {
            constructor() {
                this.currentUser = null;
                this.currentSection = 'pulse';
                this.data = {};
                this.init();
            }

        async init() {
            // Set up event listeners first
            this.setupEventListeners();
            
            // Wait for authentication to complete
            await this.waitForAuthentication();
            
            // Load initial data
            await this.loadWeeklyPulse();
            
            // Update last updated time
            this.updateLastUpdatedTime();
        }

        async waitForAuthentication() {
            // Wait for authentication to complete (max 10 seconds)
            const maxWaitTime = 10000;
            const checkInterval = 100;
            let waitTime = 0;

            while (waitTime < maxWaitTime) {
                this.currentUser = this.getCurrentUser();
                if (this.currentUser) {
                    console.log('✅ User authenticated:', this.currentUser.name);
                    return;
                }
                
                // Wait a bit and check again
                await new Promise(resolve => setTimeout(resolve, checkInterval));
                waitTime += checkInterval;
            }

            // If we get here, authentication failed
            console.error('❌ Authentication timeout - using mock data');
            this.currentUser = {
                user_id: 'mock-user-id',
                name: 'Demo User'
            };
        }

            getCurrentUser() {
                try {
                    const stored = sessionStorage.getItem('authenticatedUser');
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    console.error('Error parsing stored user:', error);
                    return null;
                }
            }

            setupEventListeners() {
                // Navigation tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        this.switchSection(section);
                    });
                });

                // Leaderboard tabs
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const leaderboard = e.target.dataset.leaderboard;
                        this.switchLeaderboard(leaderboard);
                    });
                });
            }

            switchSection(section) {
                // Update nav tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-section="${section}"]`).classList.add('active');

                // Update content sections
                document.querySelectorAll('.community-section').forEach(sec => {
                    sec.style.display = 'none';
                });
                document.getElementById(`${section}-section`).style.display = 'block';

                this.currentSection = section;

                // Load section data
                this.loadSectionData(section);
            }

            switchLeaderboard(leaderboard) {
                // Update leaderboard tabs
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-leaderboard="${leaderboard}"]`).classList.add('active');

                // Update leaderboard content
                this.renderLeaderboard(leaderboard);
            }

            async loadSectionData(section) {
                switch (section) {
                    case 'pulse':
                        await this.loadWeeklyPulse();
                        break;
                    case 'quests':
                        await this.loadQuests();
                        break;
                    case 'radar':
                        await this.loadRadar();
                        break;
                    case 'health':
                        await this.loadHealth();
                        break;
                }
            }

            async loadWeeklyPulse() {
                try {
                    console.log('🔄 Loading weekly pulse for user:', this.currentUser.user_id);
                    const response = await fetch(`/api/community/weekly?user_id=${this.currentUser.user_id}`);
                    console.log('📡 API response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const responseData = await response.json();
                    console.log('📊 API response data:', responseData);
                    console.log('Community payload source:', responseData?.source || 'unknown');
                    
                    // Add null-safety defaults to prevent crashes
                    const weekly = responseData || {};
                    weekly.recap ??= { first_degree_new: [], second_degree_delta: 0, community_activity: [], geo_expansion: [] };
                    weekly.momentum ??= {};
                    weekly.momentum.weekly_goal ??= { progress: 0, target_taps: 25 }; // fallback target
                    
                    this.data.weekly = weekly;
                    this.renderWeeklyPulse();
                } catch (error) {
                    console.error('Error loading weekly pulse:', error);
                    // Only fallback to mock if explicitly enabled via URL parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const useMock = urlParams.get('mock') === '1';
                    
                    if (useMock) {
                        console.log('Using mock data (explicitly enabled via ?mock=1)');
                        this.loadMockData();
                    } else {
                        // Show UI error instead of mock data
                        this.showUIError('Failed to load community data. Please try again.');
                    }
                }
            }

            showUIError(message) {
                console.log('📊 Showing UI error:', message);
                
                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';
                
                // Show error message in the main content area
                const contentState = document.getElementById('content-state');
                contentState.innerHTML = `
                    <div class="error-state">
                        <h3>⚠️ Unable to Load Community Data</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" class="retry-btn">Retry</button>
                    </div>
                `;
            }

            renderEmptyWeeklyState() {
                console.log('📊 Rendering empty weekly state due to data structure issues');
                
                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';
                
                // Set all values to zero/empty
                document.getElementById('new-connections-count').textContent = '0';
                document.getElementById('network-growth-count').textContent = '0';
                document.getElementById('community-activity-count').textContent = '0';
                document.getElementById('current-streak').textContent = '0';
                
                // Show error message
                const contentState = document.getElementById('content-state');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = '<p>⚠️ Unable to load community data. Please try refreshing the page.</p>';
                contentState.appendChild(errorDiv);
            }

            async loadQuests() {
                console.log('Loading quests...');
                // TODO: Implement quests loading
            }

            async loadRadar() {
                console.log('Loading radar...');
                // TODO: Implement radar loading
            }

            async loadHealth() {
                console.log('Loading health...');
                // TODO: Implement health loading
            }

            loadMockData() {
                // Use mock data for development
                this.data.weekly = {
                    recap: {
                        first_degree_new: [
                            { user_id: "u123", name: "Grace Brown", last_tap_at: "2025-01-15T18:12:00Z" },
                            { user_id: "u456", name: "Owen Chen", last_tap_at: "2025-01-14T14:30:00Z" }
                        ],
                        second_degree_delta: 22,
                        community_activity: [
                            { community_id: "c7", name: "Nashville Founders", tap_count: 31, unique_users: 14 }
                        ],
                        geo_expansion: [
                            { city: "Austin", new_taps: 5 }
                        ]
                    },
                    momentum: {
                        current_streak_days: 9,
                        longest_streak_days: 17,
                        weekly_goal: { target_taps: 5, progress: 4 }
                    },
                    leaderboard: {
                        new_connections: [
                            { user_id: "u321", name: "Owen", new_first_degree: 6 }
                        ],
                        community_builders: [
                            { user_id: "u555", name: "Mia", delta_second_degree: 18 }
                        ],
                        streak_masters: [
                            { user_id: "u789", name: "Alex", streak_days: 21 }
                        ]
                    },
                    recommendations: [
                        {
                            user_id: "u999",
                            name: "Alex Fielding",
                            mutuals: 3,
                            scores: { total: 0.69 },
                            explain: "Shared strong mutuals with Grace & Owen; also in Nashville."
                        }
                    ]
                };
                this.renderWeeklyPulse();
            }

            renderWeeklyPulse() {
                const data = this.data.weekly;
                if (!data) return;

                // Debug: Log the actual data structure
                console.log('🔍 Weekly data received:', data);
                console.log('🔍 Data.recap:', data.recap);
                console.log('🔍 Data.recap.first_degree_new:', data.recap?.first_degree_new);
                console.log('🔍 Data.meta:', data.meta);
                
                // Display meta information for debugging
                if (data.meta) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'data-status';
                    statusDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 12px; z-index: 1000;';
                    statusDiv.innerHTML = `
                        <div>Source: ${data.meta.source}</div>
                        <div>Duration: ${data.meta.duration_ms}ms</div>
                        <div>Watermark: ${new Date(data.meta.watermark).toLocaleTimeString()}</div>
                    `;
                    document.body.appendChild(statusDiv);
                }

                // Defensive guard: ensure we have the correct data structure
                if (!data.recap) {
                    console.error('❌ Invalid data structure: missing recap property');
                    this.renderEmptyWeeklyState();
                    return;
                }

                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';

                // Update recap cards with null checks
                document.getElementById('new-connections-count').textContent = data.recap?.first_degree_new?.length || 0;
                document.getElementById('network-growth-count').textContent = data.recap?.second_degree_delta || 0;
                document.getElementById('community-activity-count').textContent = data.recap?.community_activity?.length || 0;

                // Update momentum ring
                document.getElementById('current-streak').textContent = data.momentum?.current_streak_days || 0;
                
                // Update weekly goal progress with null-safety
                const goal = data.momentum?.weekly_goal ?? { progress: 0, target_taps: 25 };
                const pct = goal.target_taps ? Math.min(100, (goal.progress / goal.target_taps) * 100) : 0;
                const ring = document.getElementById('weekly-goal-progress');
                ring.style.background = `conic-gradient(var(--accent) ${pct * 3.6}deg, var(--stroke) 0deg)`;

                // Add null-safety defaults for leaderboard before calling renderLeaderboard
                data.leaderboard ??= {};
                data.leaderboard.new_connections ??= [];
                data.leaderboard.community_builders ??= [];
                data.leaderboard.streak_masters ??= [];

                // Render leaderboard
                this.renderLeaderboard('connectors');

                // Render recommendations
                this.renderRecommendations();
            }

            renderLeaderboard(type) {
                const data = this.data.weekly;
                if (!data) return;

                // Comprehensive null-safety for leaderboard
                const lb = data.leaderboard || {};
                const newConnections = Array.isArray(lb.new_connections) ? lb.new_connections : [];
                const communityBuilders = Array.isArray(lb.community_builders) ? lb.community_builders : [];
                const streakMasters = Array.isArray(lb.streak_masters) ? lb.streak_masters : [];

                // Debug logging
                console.log("Leaderboard keys:", Object.keys(lb));
                console.log("Array lengths:", {
                    newConnections: newConnections.length,
                    communityBuilders: communityBuilders.length,
                    streakMasters: streakMasters.length
                });

                // Map type to appropriate array
                let leaderboardData = [];
                if (type === 'connectors') {
                    leaderboardData = newConnections;
                } else if (type === 'reach') {
                    leaderboardData = communityBuilders;
                } else {
                    leaderboardData = streakMasters;
                }
                
                const container = document.getElementById('leaderboard-list');
                container.innerHTML = '';

                leaderboardData.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    div.innerHTML = `
                        <div>
                            <strong>${index + 1}. ${item.name}</strong>
                        </div>
                        <div>
                            ${type === 'connectors' ? item.new_first_degree + ' new' :
                              type === 'reach' ? '+' + item.delta_second_degree + ' reach' :
                              item.streak_days + ' days'}
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            renderRecommendations() {
                const data = this.data.weekly;
                if (!data) return;

                // Null-safety for recommendations
                const recs = Array.isArray(data.recommendations) ? data.recommendations : [];
                
                const container = document.getElementById('recommendations-list');
                container.innerHTML = '';

                recs.forEach(rec => {
                    const div = document.createElement('div');
                    div.className = 'recommendation-card';
                    div.innerHTML = `
                        <h4>${rec.name}</h4>
                        <div class="recommendation-scores">
                            <span class="score-badge">${Math.round(rec.scores.total * 100)}% match</span>
                            <span class="score-badge">${rec.mutuals} mutuals</span>
                        </div>
                        <p>${rec.explain}</p>
                        <div class="recommendation-actions">
                            <button class="action-btn primary">Connect</button>
                            <button class="action-btn">View Profile</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            updateLastUpdatedTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('last-updated-time').textContent = timeString;
            }
        }

        // Initialize the community page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new CommunityPage();
        });
    </script>
</body>
</html>

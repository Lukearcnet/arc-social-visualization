<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Community - ARC Social Graph</title>
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --fg-primary: #ffffff;
            --fg-secondary: #cccccc;
            --fg-muted: #888888;
            --accent: #007bff;
            --accent-hover: #0056b3;
            --stroke: #333333;
            --radius: 8px;
            --radius-2: 4px;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Disable zoom but allow scrolling */
        html {
            touch-action: pan-y;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--fg-primary);
            overflow-y: auto;
            overflow-x: hidden;
            height: 100vh;
        }

        .main-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Community Page Styles */
        .community-page {
            background: var(--bg-primary);
            color: var(--fg-primary);
            min-height: 100vh;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .community-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
        }

        .community-header h1 {
            font-size: var(--text-3xl);
            font-weight: 600;
            color: var(--fg-primary);
        }

        .last-updated {
            font-size: var(--text-sm);
            color: var(--fg-muted);
        }

        /* Navigation Tabs */
        .community-nav {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            border-bottom: 1px solid var(--stroke);
        }

        .nav-tab {
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .nav-tab.active {
            color: var(--fg-primary);
            border-bottom-color: var(--accent);
        }

        .nav-tab:hover {
            color: var(--fg-primary);
        }

        /* Recap Cards */
        .recap-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .recap-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            padding: var(--space-4);
            text-align: center;
        }

        .recap-card h3 {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            margin-bottom: var(--space-2);
        }

        .recap-value {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--fg-primary);
        }

        /* Momentum Ring */
        .momentum-section {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-8);
        }

        .momentum-ring {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--accent) 0deg, var(--stroke) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring-progress {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring-text {
            text-align: center;
        }

        .streak-days {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--accent);
        }

        .streak-label {
            font-size: var(--text-xs);
            color: var(--fg-muted);
        }

        /* Leaderboard */
        .leaderboard-section {
            margin-bottom: var(--space-8);
        }

        .leaderboard-nav {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .leaderboard-tab {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-1);
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .leaderboard-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--stroke);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        /* Recommendations */
        .recommendations-section {
            margin-bottom: var(--space-8);
        }

        .recommendations-carousel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-4);
        }

        .recommendation-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            padding: var(--space-4);
        }

        .recommendation-card h4 {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .recommendation-scores {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .score-badge {
            padding: var(--space-1) var(--space-2);
            background: var(--accent);
            color: var(--bg-primary);
            border-radius: var(--radius-1);
            font-size: var(--text-xs);
            font-weight: 500;
        }

        .recommendation-actions {
            display: flex;
            gap: var(--space-2);
        }

        .action-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-primary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-1);
            color: var(--fg-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .action-btn.primary {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .community-page {
                padding: var(--space-2);
            }
            
            .recap-strip {
                grid-template-columns: 1fr;
            }
            
            .recommendations-carousel {
                grid-template-columns: 1fr;
            }
            
            .community-nav {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1;
                min-width: 0;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--accent);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--stroke);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-4);
        }

        .loading-state p {
            color: var(--fg-muted);
            font-size: var(--text-sm);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--fg-muted);
            font-style: italic;
        }

        .empty-state div:first-child {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.6;
        }

        /* Error States */
        .error-state {
            text-align: center;
            padding: 2rem;
            color: var(--fg-muted);
        }

        .error-state h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .retry-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-2);
            cursor: pointer;
            margin-top: 1rem;
        }

        .retry-btn:hover {
            background: var(--accent-hover);
        }

        /* Warning Banner */
        .warning-banner {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Community Section Visibility */
        .community-section {
            display: none;
        }
        
        .community-section.active {
            display: block;
        }
        
        .community-content {
            min-height: 400px;
        }

        /* Quests Section Styles */
        .quests-container {
            padding: var(--space-4);
            max-width: 600px;
            margin: 0 auto;
            min-height: 400px; /* Ensure minimum height */
            background: var(--bg-secondary); /* Temporary background for debugging */
            border: 2px solid var(--accent); /* Temporary border for debugging */
        }

        /* Radar Section Styles */
        .radar-container {
            padding: var(--space-4);
            max-width: 800px;
            margin: 0 auto;
            min-height: 400px;
        }

        .radar-header {
            margin-bottom: var(--space-6);
        }

        .radar-header h2 {
            font-size: var(--text-3xl);
            font-weight: 600;
            color: var(--fg-primary);
            margin-bottom: var(--space-2);
        }

        .radar-subtitle {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            margin-bottom: var(--space-4);
        }

        .timezone-info {
            font-size: var(--text-xs);
            color: var(--fg-muted);
        }

        .activity-timeline {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-bottom: var(--space-6);
            background: var(--bg-secondary);
            padding: var(--space-2);
            border-radius: var(--radius);
        }

        .hour-bucket {
            aspect-ratio: 1;
            border-radius: var(--radius-2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--text-xs);
            color: var(--fg-muted);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .hour-bucket:hover {
            transform: scale(1.05);
        }

        .hour-bucket.low { background: var(--stroke); }
        .hour-bucket.medium { background: var(--accent); opacity: 0.6; }
        .hour-bucket.high { background: var(--accent); opacity: 0.8; }
        .hour-bucket.surge { background: var(--accent); opacity: 1; }

        .participants-section {
            margin-bottom: var(--space-6);
        }

        .participants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .participant-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: var(--space-4);
            transition: all 0.2s ease;
        }

        .participant-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .participant-name {
            font-weight: 600;
            color: var(--fg-primary);
            margin-bottom: var(--space-2);
        }

        .participant-activity {
            font-size: var(--text-sm);
            color: var(--fg-muted);
        }

        .surge-indicator {
            background: var(--accent);
            color: var(--bg-primary);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius);
            font-size: var(--text-sm);
            font-weight: 600;
            margin-bottom: var(--space-4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .quests-header {
            margin-bottom: var(--space-6);
        }

        .quests-header h2 {
            font-size: var(--text-3xl);
            font-weight: 600;
            color: var(--fg-primary);
            margin-bottom: var(--space-2);
        }

        .quests-subtitle {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            margin-bottom: var(--space-4);
        }

        .week-info {
            font-size: var(--text-xs);
            color: var(--fg-muted);
            background: var(--bg-secondary);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-2);
            display: inline-block;
        }

        .quests-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .quest-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: var(--space-4);
            transition: all 0.2s ease;
        }

        .quest-card:hover {
            border-color: var(--accent);
        }

        .quest-card.completed {
            border-color: var(--success);
        }

        .quest-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .quest-icon {
            font-size: var(--text-xl);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-2);
        }

        .quest-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--fg-primary);
        }

        .quest-progress {
            margin-bottom: var(--space-3);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-2);
            overflow: hidden;
            margin-bottom: var(--space-2);
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: var(--radius-2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-fill.completed {
            background: var(--success);
        }

        .progress-fill.over-achieved {
            background: var(--warning);
        }

        .progress-text {
            font-size: var(--text-sm);
            color: var(--fg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-percentage {
            font-weight: 600;
            color: var(--fg-primary);
        }

        .quest-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--fg-muted);
        }

        .status-indicator.completed {
            background: var(--success);
        }

        .status-indicator.in-progress {
            background: var(--accent);
        }

        .status-indicator.not-started {
            background: var(--fg-muted);
        }

        /* Health Section Styles */
        .health-container {
            padding: var(--space-4);
            max-width: 800px;
            margin: 0 auto;
            min-height: 400px;
        }

        .health-header {
            margin-bottom: var(--space-6);
        }

        .health-header h2 {
            font-size: var(--text-3xl);
            font-weight: 600;
            color: var(--fg-primary);
            margin-bottom: var(--space-2);
        }

        .health-subtitle {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            margin-bottom: var(--space-4);
        }

        .health-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .health-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: var(--space-4);
            text-align: center;
            transition: all 0.2s ease;
        }

        .health-stat-card:hover {
            border-color: var(--accent);
        }

        .health-stat-number {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--fg-primary);
            margin-bottom: var(--space-1);
        }

        .health-stat-label {
            font-size: var(--text-sm);
            color: var(--fg-muted);
        }

        .connections-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .connection-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: var(--space-4);
            transition: all 0.2s ease;
        }

        .connection-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .connection-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }

        .connection-name {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--fg-primary);
        }

        .health-badge {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-2);
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
        }

        .health-badge.excellent {
            background: #10b981;
            color: white;
        }

        .health-badge.good {
            background: var(--accent);
            color: white;
        }

        .health-badge.fair {
            background: #f59e0b;
            color: white;
        }

        .health-badge.needs_attention {
            background: #ef4444;
            color: white;
        }

        .strength-section {
            margin-bottom: var(--space-3);
        }

        .strength-label {
            font-size: var(--text-sm);
            color: var(--fg-secondary);
            margin-bottom: var(--space-1);
        }

        .strength-indicator {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-2);
            overflow: hidden;
            margin-bottom: var(--space-2);
        }

        .strength-fill {
            height: 100%;
            background: var(--accent);
            border-radius: var(--radius-2);
            transition: width 0.3s ease;
        }

        .strength-fill.excellent {
            background: #10b981;
        }

        .strength-fill.good {
            background: var(--accent);
        }

        .strength-fill.fair {
            background: #f59e0b;
        }

        .strength-fill.needs_attention {
            background: #ef4444;
        }

        .strength-text {
            font-size: var(--text-sm);
            color: var(--fg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .metric-item {
            text-align: center;
        }

        .metric-value {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--fg-primary);
            margin-bottom: var(--space-1);
        }

        .metric-label {
            font-size: var(--text-xs);
            color: var(--fg-muted);
        }

        .last-tap-info {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            text-align: center;
        }

        /* Time Window Selector Styles */
        .time-window-selector {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            padding: var(--space-4);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--stroke);
        }

        .time-window-selector label {
            font-size: var(--text-sm);
            color: var(--fg-secondary);
            font-weight: 500;
        }

        .time-window-dropdown {
            background: var(--bg-tertiary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            color: var(--fg-primary);
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-window-dropdown:hover {
            border-color: var(--accent);
        }

        .time-window-dropdown:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.2);
        }

        .time-period-display {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            font-style: italic;
        }

        /* Clickable Recap Cards */
        .recap-card.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .recap-card.clickable:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .recap-card.clickable:active {
            transform: translateY(0);
        }

        .recap-subtitle {
            font-size: var(--text-xs);
            color: var(--fg-muted);
            margin-top: var(--space-1);
            text-align: center;
        }

        /* Dropdown Styles */
        .degree-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .degree-dropdown.show {
            display: block;
        }

        .degree-user-item {
            padding: var(--space-3);
            border-bottom: 1px solid var(--stroke);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s ease;
        }

        .degree-user-item:hover {
            background: var(--bg-tertiary);
        }

        .degree-user-item:last-child {
            border-bottom: none;
        }

        .user-name {
            font-weight: 500;
            color: var(--fg-primary);
        }

        .user-meta {
            font-size: var(--text-xs);
            color: var(--fg-muted);
        }

        .refresh-button {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            color: var(--fg-secondary);
            padding: var(--space-2);
            border-radius: var(--radius-2);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: all 0.2s ease;
        }

        .refresh-button:hover {
            background: var(--bg-tertiary);
            color: var(--fg-primary);
        }

        .refresh-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .routes-placeholder {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: var(--space-4);
            margin-top: var(--space-6);
            text-align: center;
            color: var(--fg-muted);
        }

        .routes-placeholder h3 {
            font-size: var(--text-lg);
            margin-bottom: var(--space-2);
            color: var(--fg-secondary);
        }

        .routes-placeholder p {
            font-size: var(--text-sm);
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .progress-fill {
                transition: none;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="content-area">
            <div id="community-container" class="community-page">
                <!-- Header -->
                <div class="community-header">
                    <h1>Community</h1>
                    <div class="last-updated">Last updated at <span id="last-updated-time"></span></div>
                </div>

                <!-- Navigation Tabs -->
                <div class="community-nav">
                    <button class="nav-tab active" data-section="pulse">Weekly Pulse</button>
                    <button class="nav-tab" data-section="quests">Quests & Routes</button>
                    <button class="nav-tab" data-section="radar">Opportunity Radar</button>
                    <button class="nav-tab" data-section="health">Relationship Health</button>
                </div>

                <!-- Content Sections -->
                <div class="community-content">
                        <!-- Weekly Pulse Section -->
                        <div id="pulse-section" class="community-section active">
                            <!-- Loading State -->
                            <div id="loading-state" class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading your community data...</p>
                            </div>
                            
                            <!-- Content (hidden initially) -->
                            <div id="content-state" style="display: none;">
                                <!-- Time Window Selector -->
                                <div class="time-window-selector">
                                    <label for="time-window">Time Period:</label>
                                    <select id="time-window" class="time-window-dropdown">
                                        <option value="1day">Last 24 Hours</option>
                                        <option value="1week" selected>Last 7 Days</option>
                                        <option value="1month">Last 30 Days</option>
                                        <option value="6months">Last 6 Months</option>
                                        <option value="1year">Last Year</option>
                                    </select>
                                    <div class="time-period-display" id="time-period-display">Last 7 Days</div>
                                </div>

                                <!-- Recap Cards -->
                                <div class="recap-strip">
                                    <div class="recap-card clickable" id="first-degree-card">
                                        <h3>New 1st Degree</h3>
                                        <div class="recap-value" id="first-degree-count">-</div>
                                        <div class="recap-subtitle">Direct connections</div>
                                    </div>
                                    <div class="recap-card clickable" id="second-degree-card">
                                        <h3>New 2nd Degree</h3>
                                        <div class="recap-value" id="second-degree-count">-</div>
                                        <div class="recap-subtitle">Friends of friends</div>
                                    </div>
                                    <div class="recap-card clickable" id="third-degree-card">
                                        <h3>New 3rd Degree</h3>
                                        <div class="recap-value" id="third-degree-count">-</div>
                                        <div class="recap-subtitle">Friends of friends of friends</div>
                                    </div>
                                </div>

                        <!-- Momentum Ring -->
                        <div class="momentum-section">
                            <div class="momentum-ring">
                                <div class="ring-progress" id="weekly-goal-progress"></div>
                                <div class="ring-text">
                                    <div class="streak-days" id="current-streak">-</div>
                                    <div class="streak-label">day streak</div>
                                </div>
                            </div>
                        </div>

                        <!-- Leaderboard Tabs -->
                        <div class="leaderboard-section">
                            <div class="leaderboard-nav">
                                <button class="leaderboard-tab active" data-leaderboard="connectors">Top Connectors</button>
                                <button class="leaderboard-tab" data-leaderboard="reach">Expanding Reach</button>
                                <button class="leaderboard-tab" data-leaderboard="consistency">Consistency</button>
                            </div>
                            <div class="leaderboard-content" id="leaderboard-list"></div>
                        </div>

                        <!-- Recommendations -->
                        <div class="recommendations-section">
                            <h3>People You Should Meet</h3>
                            <div class="recommendations-carousel" id="recommendations-list"></div>
                        </div>
                            </div>
                        </div>

                    <!-- Other sections will be added here -->
                    <div id="quests-section" class="community-section">
                        <div class="quests-container">
                            <div class="quests-header">
                                <h2>Quests & Routes</h2>
                                <div class="quests-subtitle">Complete weekly challenges to grow your network</div>
                                <div class="week-info" id="quests-week-info">Loading week info...</div>
                            </div>

                            <button class="refresh-button" id="quests-refresh-button" title="Refresh quests">
                                ↻
                            </button>

                            <div id="quests-content">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <div>Loading quests...</div>
                                </div>
                            </div>

                            <div class="routes-placeholder">
                                <h3>Routes</h3>
                                <p>Personalized connection suggestions coming soon</p>
                            </div>
                        </div>
                    </div>

                    <div id="radar-section" class="community-section">
                        <div class="radar-container">
                            <div class="radar-header">
                                <h2>Opportunity Radar</h2>
                                <div class="radar-subtitle">Live network activity and connection opportunities</div>
                                <div class="timezone-info" id="radar-timezone-info">Loading timezone...</div>
                            </div>

                            <button class="refresh-button" id="radar-refresh-button" title="Refresh radar">
                                ↻
                            </button>

                            <div id="radar-content">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <div>Loading activity data...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="health-section" class="community-section">
                        <div class="health-container">
                            <div class="health-header">
                                <h2>Relationship Health</h2>
                                <div class="health-subtitle">Connection strength analysis and relationship insights</div>
                            </div>

                            <button class="refresh-button" id="health-refresh-button" title="Refresh health data">
                                ↻
                            </button>

                            <div id="health-content">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <div>Loading relationship data...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Community Page JavaScript
        class CommunityPage {
            constructor() {
                this.currentUser = null;
                this.currentSection = 'pulse';
                this.data = {};
                this.init();
            }

            // Helper function for safe array access
            safeArr(v) { 
                return Array.isArray(v) ? v : []; 
            }

            // Validation helper for weekly payload
            validateWeeklyPayload(data) {
                const warnings = [];
                const errors = [];

                // Check required top-level fields
                if (!data) {
                    errors.push('Payload is null/undefined');
                    return { valid: false, errors, warnings };
                }

                if (!data.source) warnings.push('Missing source field');
                if (!data.week) errors.push('Missing week object');
                if (!data.recap) errors.push('Missing recap object');
                if (!data.momentum) errors.push('Missing momentum object');
                if (!data.leaderboard) errors.push('Missing leaderboard object');
                if (!data.meta) errors.push('Missing meta object');

                // Check recap structure
                if (data.recap) {
                    if (!Array.isArray(data.recap.first_degree_new)) warnings.push('recap.first_degree_new should be array');
                    if (typeof data.recap.second_degree_delta !== 'number') warnings.push('recap.second_degree_delta should be number');
                    if (!Array.isArray(data.recap.community_activity)) warnings.push('recap.community_activity should be array');
                    if (!Array.isArray(data.recap.geo_expansion)) warnings.push('recap.geo_expansion should be array');
                }

                // Check momentum structure
                if (data.momentum) {
                    if (typeof data.momentum.current_streak_days !== 'number') warnings.push('momentum.current_streak_days should be number');
                    if (typeof data.momentum.longest_streak_days !== 'number') warnings.push('momentum.longest_streak_days should be number');
                    if (typeof data.momentum.weekly_taps !== 'number') warnings.push('momentum.weekly_taps should be number');
                    if (typeof data.momentum.new_connections !== 'number') warnings.push('momentum.new_connections should be number');
                    if (!data.momentum.weekly_goal) warnings.push('Missing momentum.weekly_goal');
                    if (data.momentum.weekly_goal) {
                        if (typeof data.momentum.weekly_goal.progress !== 'number') warnings.push('momentum.weekly_goal.progress should be number');
                        if (typeof data.momentum.weekly_goal.target_taps !== 'number') warnings.push('momentum.weekly_goal.target_taps should be number');
                    }
                }

                // Check leaderboard structure
                if (data.leaderboard) {
                    if (!Array.isArray(data.leaderboard.new_connections)) warnings.push('leaderboard.new_connections should be array');
                    if (!Array.isArray(data.leaderboard.community_builders)) warnings.push('leaderboard.community_builders should be array');
                    if (!Array.isArray(data.leaderboard.streak_masters)) warnings.push('leaderboard.streak_masters should be array');
                }

                // Check recommendations
                if (!Array.isArray(data.recommendations)) warnings.push('recommendations should be array');

                // Check meta structure
                if (data.meta) {
                    if (!data.meta.source) warnings.push('Missing meta.source');
                    if (typeof data.meta.duration_ms !== 'number') warnings.push('meta.duration_ms should be number');
                    if (!data.meta.user_id) warnings.push('Missing meta.user_id');
                    if (!data.meta.watermark) warnings.push('Missing meta.watermark');
                    if (!Array.isArray(data.meta.warnings)) warnings.push('meta.warnings should be array');
                }

                const valid = errors.length === 0;
                
                if (!valid || warnings.length > 0) {
                    console.warn('COMMUNITY: Weekly payload validation issues:', {
                        valid,
                        errors,
                        warnings,
                        payloadKeys: Object.keys(data || {}),
                        source: data?.source || 'unknown'
                    });
                }

                return { valid, errors, warnings };
            }

        async init() {
            // Set up event listeners first
            this.setupEventListeners();
            
            // Wait for authentication to complete
            await this.waitForAuthentication();
            
            // Runtime sanity check: verify DOM structure
            this.validateDOMStructure();
            
            // Ensure the initial section is displayed
            this.switchSection('pulse');
            
            // Load initial data
            await this.loadWeeklyPulse();
            
            // Update last updated time
            this.updateLastUpdatedTime();
        }

        validateDOMStructure() {
            const communityContent = document.querySelector('.community-content');
            if (!communityContent) {
                console.error('❌ [Community] .community-content not found!');
                return;
            }

            const sections = ['pulse-section', 'quests-section', 'radar-section', 'health-section'];
            const errors = [];

            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (!section) {
                    errors.push(`❌ [Community] ${sectionId} not found!`);
                    return;
                }

                const parent = section.parentElement;
                if (parent !== communityContent) {
                    errors.push(`❌ [Community] ${sectionId} parent is ${parent?.className || 'unknown'}, expected .community-content`);
                }
            });

            if (errors.length > 0) {
                console.error('❌ [Community] DOM structure validation failed:');
                errors.forEach(error => console.error(error));
            } else {
                console.log('✅ [Community] DOM structure validation passed - all sections are direct children of .community-content');
            }
        }

        async waitForAuthentication() {
            // Wait for authentication to complete (max 10 seconds)
            const maxWaitTime = 10000;
            const checkInterval = 100;
            let waitTime = 0;

            while (waitTime < maxWaitTime) {
                this.currentUser = this.getCurrentUser();
                if (this.currentUser) {
                    console.log('✅ User authenticated:', this.currentUser.name);
                    return;
                }
                
                // Wait a bit and check again
                await new Promise(resolve => setTimeout(resolve, checkInterval));
                waitTime += checkInterval;
            }

            // If we get here, authentication failed
            console.error('❌ Authentication timeout - using mock data');
            this.currentUser = {
                user_id: 'mock-user-id',
                name: 'Demo User'
            };
        }

            getCurrentUser() {
                try {
                    const stored = sessionStorage.getItem('authenticatedUser');
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    console.error('Error parsing stored user:', error);
                    return null;
                }
            }

            setupEventListeners() {
                // Navigation tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        this.switchSection(section);
                    });
                });

                // Leaderboard tabs
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const leaderboard = e.target.dataset.leaderboard;
                        this.switchLeaderboard(leaderboard);
                    });
                });
            }

            switchSection(section) {
                console.log('🔄 [Community] Switching to section:', section);
                
                // Update nav tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-section="${section}"]`).classList.add('active');

                // Hide all community sections by removing active class
                document.querySelectorAll('.community-section').forEach(sec => {
                    sec.classList.remove('active');
                });
                
                // Show only the target section by adding active class
                const targetSection = document.getElementById(`${section}-section`);
                console.log('🔄 [Community] Target section element:', targetSection);
                
                if (targetSection) {
                    targetSection.classList.add('active');
                    console.log('🔄 [Community] Section displayed');
                } else {
                    console.error('❌ [Community] Section not found:', `${section}-section`);
                }

                this.currentSection = section;

                // Debug: Log each section's computed display and active class
                console.log('🔍 [Community] Section visibility debug:');
                document.querySelectorAll('.community-section').forEach(sec => {
                    const computedStyle = window.getComputedStyle(sec);
                    console.log(`  ${sec.id}: display=${computedStyle.display}, hasActive=${sec.classList.contains('active')}`);
                });

                // Load section data
                this.loadSectionData(section);
            }

            switchLeaderboard(leaderboard) {
                // Update leaderboard tabs
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-leaderboard="${leaderboard}"]`).classList.add('active');

                // Update leaderboard content
                this.renderLeaderboard(leaderboard);
            }

            async loadSectionData(section) {
                switch (section) {
                    case 'pulse':
                        await this.loadWeeklyPulse();
                        break;
                    case 'quests':
                        await this.loadQuests();
                        break;
                    case 'radar':
                        await this.loadRadar();
                        break;
                    case 'health':
                        await this.loadHealth();
                        break;
                }
            }

            async loadWeeklyPulse() {
                try {
                    console.log('🔄 Loading weekly pulse for user:', this.currentUser.user_id);
                    const response = await fetch(`/api/community/weekly?user_id=${this.currentUser.user_id}&time_window=7d`);
                    console.log('📡 API response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const responseData = await response.json();
                    console.log('📊 API response data:', responseData);
                    console.log('Community payload source:', responseData?.source || 'unknown');
                    
                    // Validate payload structure
                    this.validateWeeklyPayload(responseData);
                    
                    // Normalize data with safe access patterns
                    const data = responseData || {};
                    const recap = data?.recap ?? {};
                    const momentum = data?.momentum ?? {};
                    const leaderboard = data?.leaderboard ?? {};
                    const recommendations = this.safeArr(data?.recommendations);
                    const warnings = this.safeArr(data?.meta?.warnings);
                    
                    // Normalize arrays used in loops
                    const firstDegree = this.safeArr(recap.first_degree_new);
                    const communityActivity = this.safeArr(recap.community_activity);
                    const geoExpansion = this.safeArr(recap.geo_expansion);
                    const newConnections = this.safeArr(leaderboard.new_connections);
                    const communityBuilders = this.safeArr(leaderboard.community_builders);
                    const streakMasters = this.safeArr(leaderboard.streak_masters);
                    
                    // Store normalized data
                    this.data.weekly = {
                        ...data,
                        recap: {
                            ...recap,
                            first_degree_new: firstDegree,
                            community_activity: communityActivity,
                            geo_expansion: geoExpansion
                        },
                        momentum,
                        leaderboard: {
                            new_connections: newConnections,
                            community_builders: communityBuilders,
                            streak_masters: streakMasters
                        },
                        recommendations,
                        warnings
                    };
                    
                    this.renderWeeklyPulse();
                } catch (error) {
                    console.error('Error loading weekly pulse:', error);
                    // Only fallback to mock if explicitly enabled via URL parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const useMock = urlParams.get('mock') === '1';
                    
                    if (useMock) {
                        console.log('Using mock data (explicitly enabled via ?mock=1)');
                        this.loadMockData();
                    } else {
                        // Show UI error instead of mock data
                        this.showUIError('Failed to load community data. Please try again.');
                    }
                }
            }

            showUIError(message) {
                console.log('📊 Showing UI error:', message);
                
                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';
                
                // Show error message in the main content area
                const contentState = document.getElementById('content-state');
                contentState.innerHTML = `
                    <div class="error-state">
                        <h3>⚠️ Unable to Load Community Data</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" class="retry-btn">Retry</button>
                    </div>
                `;
            }

            renderEmptyWeeklyState() {
                console.log('📊 Rendering empty weekly state due to data structure issues');
                
                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';
                
                // Set all values to zero/empty
                document.getElementById('first-degree-count').textContent = '0';
                document.getElementById('second-degree-count').textContent = '0';
                document.getElementById('third-degree-count').textContent = '0';
                document.getElementById('current-streak').textContent = '0';
                
                // Show error message
                const contentState = document.getElementById('content-state');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = '<p>⚠️ Unable to load community data. Please try refreshing the page.</p>';
                contentState.appendChild(errorDiv);
            }

            getTimePeriodText(timeWindow) {
                const periodMap = {
                    '1day': 'Last 24 Hours',
                    '1week': 'Last 7 Days',
                    '1month': 'Last 30 Days',
                    '6months': 'Last 6 Months',
                    '1year': 'Last Year'
                };
                return periodMap[timeWindow] || 'Last 7 Days';
            }

            setupTimeWindowSelector() {
                const timeWindowSelect = document.getElementById('time-window');
                if (!timeWindowSelect) return;

                timeWindowSelect.addEventListener('change', (e) => {
                    const newTimeWindow = e.target.value;
                    console.log('🕒 Time window changed to:', newTimeWindow);
                    this.loadWeeklyPulseWithTimeWindow(newTimeWindow);
                });
            }

            async loadWeeklyPulseWithTimeWindow(timeWindow) {
                try {
                    console.log('🔄 Loading weekly pulse with time window:', timeWindow);
                    const response = await fetch(`/api/community/weekly?user_id=${this.currentUser.user_id}&time_window=${timeWindow}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const responseData = await response.json();
                    console.log('📊 API response with time window:', responseData);
                    
                    // Update data and re-render
                    this.data.weekly = responseData;
                    this.renderWeeklyPulse();
                    
                } catch (error) {
                    console.error('Error loading weekly pulse with time window:', error);
                    this.showUIError('Failed to load data for selected time period. Please try again.');
                }
            }

            setupDegreeDropdowns() {
                // Setup click handlers for degree cards
                const firstDegreeCard = document.getElementById('first-degree-card');
                const secondDegreeCard = document.getElementById('second-degree-card');
                const thirdDegreeCard = document.getElementById('third-degree-card');

                if (firstDegreeCard) {
                    firstDegreeCard.addEventListener('click', () => this.toggleDegreeDropdown('first'));
                }
                if (secondDegreeCard) {
                    secondDegreeCard.addEventListener('click', () => this.toggleDegreeDropdown('second'));
                }
                if (thirdDegreeCard) {
                    thirdDegreeCard.addEventListener('click', () => this.toggleDegreeDropdown('third'));
                }

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.recap-card.clickable')) {
                        this.closeAllDropdowns();
                    }
                });
            }

            toggleDegreeDropdown(degree) {
                // Close all other dropdowns first
                this.closeAllDropdowns();

                const card = document.getElementById(`${degree}-degree-card`);
                if (!card) return;

                const users = this.degreeData[degree] || [];
                if (users.length === 0) {
                    console.log(`No ${degree} degree users to show`);
                    return;
                }

                // Create dropdown if it doesn't exist
                let dropdown = card.querySelector('.degree-dropdown');
                if (!dropdown) {
                    dropdown = document.createElement('div');
                    dropdown.className = 'degree-dropdown';
                    card.appendChild(dropdown);
                }

                // Populate dropdown with users
                dropdown.innerHTML = users.map(user => `
                    <div class="degree-user-item">
                        <div class="user-name">${user.name}</div>
                        <div class="user-meta">
                            ${user.connected_via ? `via ${user.connected_via}` : ''}
                            <br>
                            ${new Date(user.last_tap_at).toLocaleDateString()}
                        </div>
                    </div>
                `).join('');

                // Show dropdown
                dropdown.classList.add('show');
            }

            closeAllDropdowns() {
                document.querySelectorAll('.degree-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }

            async loadQuests() {
                console.log('Loading quests...');
                // TODO: Implement quests loading
            }

            async loadRadar() {
                console.log('Loading radar...');
                // TODO: Implement radar loading
            }

            async loadHealth() {
                console.log('🏥 [Health] Loading health data...');
                
                try {
                    const userId = this.currentUser?.user_id || this.currentUser?.id;
                    if (!userId) {
                        throw new Error('No user ID available');
                    }

                    const response = await fetch(`/api/community/health?user_id=${userId}&debug=1`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('🏥 [Health] Loaded:', data);
                    
                    this.renderHealth(data);
                    
                } catch (error) {
                    console.error('❌ [Health] Failed to load:', error);
                    this.renderHealthError(error);
                }
            }

            renderHealth(data) {
                console.log('🏥 [Health] Rendering health:', data);
                const content = document.getElementById('health-content');
                console.log('🏥 [Health] Content element:', content);
                
                if (!content) {
                    console.error('❌ [Health] health-content element not found!');
                    return;
                }
                
                // Hide loading state
                const loadingState = content.querySelector('.loading-state');
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                
                if (!data.connections || data.connections.length === 0) {
                    console.log('🏥 [Health] No connections data, showing empty state');
                    this.renderHealthEmpty();
                    return;
                }
                
                console.log('🏥 [Health] Found', data.connections.length, 'connections');
                
                // Generate summary stats
                const summaryHTML = this.renderHealthSummary(data.summary);
                
                // Generate connections list
                const connectionsHTML = this.renderConnections(data.connections);
                
                content.innerHTML = `
                    <div class="health-summary">
                        ${summaryHTML}
                    </div>
                    <div class="connections-list">
                        ${connectionsHTML}
                    </div>
                `;

                console.log('🏥 [Health] Content updated, innerHTML length:', content.innerHTML.length);

                // Setup refresh button
                this.setupHealthRefresh();
            }

            renderHealthSummary(summary) {
                const stats = [
                    { label: 'Excellent', count: summary.excellent || 0, class: 'excellent' },
                    { label: 'Good', count: summary.good || 0, class: 'good' },
                    { label: 'Fair', count: summary.fair || 0, class: 'fair' },
                    { label: 'Needs Attention', count: summary.needs_attention || 0, class: 'needs_attention' }
                ];

                return stats.map(stat => `
                    <div class="health-stat-card">
                        <div class="health-stat-number">${stat.count}</div>
                        <div class="health-stat-label">${stat.label}</div>
                    </div>
                `).join('');
            }

            renderConnections(connections) {
                if (!connections || connections.length === 0) {
                    return '<div class="empty-state">No connections found</div>';
                }
                
                return connections.map(connection => `
                    <div class="connection-card">
                        <div class="connection-header">
                            <div class="connection-name">${connection.name}</div>
                            <div class="health-badge ${connection.health}">${connection.health.replace('_', ' ')}</div>
                        </div>
                        
                        <div class="strength-section">
                            <div class="strength-label">Relationship Strength</div>
                            <div class="strength-indicator">
                                <div class="strength-fill ${connection.health}" style="width: ${(connection.strength_f32 * 100).toFixed(1)}%"></div>
                            </div>
                            <div class="strength-text">
                                <span>${(connection.strength_f32 * 100).toFixed(1)}%</span>
                                <span>${connection.health.replace('_', ' ')}</span>
                            </div>
                        </div>
                        
                        <div class="connection-metrics">
                            <div class="metric-item">
                                <div class="metric-value">${connection.taps_7d}</div>
                                <div class="metric-label">7d</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${connection.taps_30d}</div>
                                <div class="metric-label">30d</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${connection.taps_90d}</div>
                                <div class="metric-label">90d</div>
                            </div>
                        </div>
                        
                        <div class="last-tap-info">
                            Last interaction: ${connection.days_since_last_tap} days ago
                        </div>
                    </div>
                `).join('');
            }

            renderHealthError(error) {
                const content = document.getElementById('health-content');
                if (!content) return;
                
                // Hide loading state
                const loadingState = content.querySelector('.loading-state');
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                
                content.innerHTML = `
                    <div class="error-state">
                        <div class="error-icon">⚠️</div>
                        <div class="error-message">Failed to load relationship data</div>
                        <div class="error-details">${error.message}</div>
                        <button class="retry-button" onclick="window.communityPage.loadHealth()">Try Again</button>
                    </div>
                `;
            }

            renderHealthEmpty() {
                const content = document.getElementById('health-content');
                if (!content) return;
                
                // Hide loading state
                const loadingState = content.querySelector('.loading-state');
                if (loadingState) {
                    loadingState.style.display = 'none';
                }
                
                content.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📊</div>
                        <div class="empty-message">No relationship data available</div>
                        <div class="empty-details">Start connecting with people to see relationship insights</div>
                    </div>
                `;
            }

            loadMockData() {
                // Use mock data for development
                this.data.weekly = {
                    recap: {
                        first_degree_new: [
                            { user_id: "u123", name: "Grace Brown", last_tap_at: "2025-01-15T18:12:00Z" },
                            { user_id: "u456", name: "Owen Chen", last_tap_at: "2025-01-14T14:30:00Z" }
                        ],
                        second_degree_delta: 22,
                        community_activity: [
                            { community_id: "c7", name: "Nashville Founders", tap_count: 31, unique_users: 14 }
                        ],
                        geo_expansion: [
                            { city: "Austin", new_taps: 5 }
                        ]
                    },
                    momentum: {
                        current_streak_days: 9,
                        longest_streak_days: 17,
                        weekly_goal: { target_taps: 5, progress: 4 }
                    },
                    leaderboard: {
                        new_connections: [
                            { user_id: "u321", name: "Owen", new_first_degree: 6 }
                        ],
                        community_builders: [
                            { user_id: "u555", name: "Mia", delta_second_degree: 18 }
                        ],
                        streak_masters: [
                            { user_id: "u789", name: "Alex", streak_days: 21 }
                        ]
                    },
                    recommendations: [
                        {
                            user_id: "u999",
                            name: "Alex Fielding",
                            mutuals: 3,
                            scores: { total: 0.69 },
                            explain: "Shared strong mutuals with Grace & Owen; also in Nashville."
                        }
                    ]
                };
                this.renderWeeklyPulse();
            }

            renderWeeklyPulse() {
                const data = this.data.weekly;
                if (!data) return;

                // Debug logging (only if debug=1)
                const urlParams = new URLSearchParams(window.location.search);
                const isDebug = urlParams.get('debug') === '1';
                
                if (isDebug) {
                    console.log('🔍 Weekly data received:', data);
                    console.log('🔍 Data.recap:', data.recap);
                    console.log('🔍 Data.recap.first_degree_new:', data.recap?.first_degree_new);
                    console.log('🔍 Data.meta:', data.meta);
                }
                
                // Display meta information for debugging
                if (data.meta && isDebug) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'data-status';
                    statusDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 12px; z-index: 1000;';
                    statusDiv.innerHTML = `
                        <div>Source: ${data.meta.source}</div>
                        <div>Duration: ${data.meta.duration_ms}ms</div>
                        <div>Watermark: ${new Date(data.meta.watermark).toLocaleTimeString()}</div>
                    `;
                    document.body.appendChild(statusDiv);
                }

                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';

                // Update recap cards with new degree structure
                const firstDegreeCount = this.safeArr(data.recap?.first_degree_new).length;
                const secondDegreeCount = this.safeArr(data.recap?.second_degree_new).length;
                const thirdDegreeCount = this.safeArr(data.recap?.third_degree_new).length;
                
                console.log(`COMMUNITY: Degree cards - 1st:${firstDegreeCount}, 2nd:${secondDegreeCount}, 3rd:${thirdDegreeCount}`);
                
                document.getElementById('first-degree-count').textContent = firstDegreeCount;
                document.getElementById('second-degree-count').textContent = secondDegreeCount;
                document.getElementById('third-degree-count').textContent = thirdDegreeCount;

                // Update time period display
                const timeWindow = data.week?.time_window || '1week';
                const timePeriodText = this.getTimePeriodText(timeWindow);
                document.getElementById('time-period-display').textContent = timePeriodText;

                // Store degree data for dropdowns
                this.degreeData = {
                    first: data.recap?.first_degree_new || [],
                    second: data.recap?.second_degree_new || [],
                    third: data.recap?.third_degree_new || []
                };

                // Setup time window selector
                this.setupTimeWindowSelector();
                
                // Setup degree card dropdowns
                this.setupDegreeDropdowns();

                // Update momentum ring
                document.getElementById('current-streak').textContent = data.momentum?.current_streak_days || 0;
                
                // Update weekly goal progress with null-safety
                const wg = data.momentum?.weekly_goal ?? {};
                const wgProgress = Number.isFinite(wg.progress) ? wg.progress : 0;
                const wgTarget = Number.isFinite(wg.target_taps) && wg.target_taps > 0 ? wg.target_taps : 25;
                const wgPct = Math.max(0, Math.min(100, (wgTarget ? (wgProgress / wgTarget) * 100 : 0)));
                
                const ring = document.getElementById('weekly-goal-progress');
                ring.style.background = `conic-gradient(var(--accent) ${wgPct * 3.6}deg, var(--stroke) 0deg)`;

                // Render leaderboard
                this.renderLeaderboard('connectors');

                // Render recommendations
                this.renderRecommendations();
                
                // Render warnings if present
                this.renderWarnings();
            }

            renderLeaderboard(type) {
                const data = this.data.weekly;
                if (!data) return;

                // Use safe array access
                const newConnections = this.safeArr(data.leaderboard?.new_connections);
                const communityBuilders = this.safeArr(data.leaderboard?.community_builders);
                const streakMasters = this.safeArr(data.leaderboard?.streak_masters);

                // Map type to appropriate array
                let leaderboardData = [];
                let emptyMessage = '';
                
                if (type === 'connectors') {
                    leaderboardData = newConnections;
                    emptyMessage = 'No new connections ranked yet this week.';
                } else if (type === 'reach') {
                    leaderboardData = communityBuilders;
                    emptyMessage = 'No high-activity builders yet this week.';
                } else {
                    leaderboardData = streakMasters;
                    emptyMessage = 'No active streaks to show yet.';
                }
                
                const container = document.getElementById('leaderboard-list');
                container.innerHTML = '';

                if (leaderboardData.length === 0) {
                    console.log(`COMMUNITY: Leaderboard:${type} empty because length=${leaderboardData.length}`);
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-state';
                    emptyDiv.style.cssText = 'text-align: center; padding: 2rem; color: var(--fg-muted); font-style: italic;';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📊</div>
                        <div>${emptyMessage}</div>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }

                leaderboardData.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    div.innerHTML = `
                        <div>
                            <strong>${index + 1}. ${item.name || 'Unknown'}</strong>
                        </div>
                        <div>
                            ${type === 'connectors' ? (item.new_first_degree || 0) + ' new' :
                              type === 'reach' ? '+' + (item.delta_second_degree || 0) + ' reach' :
                              (item.streak_days || 0) + ' days'}
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            renderRecommendations() {
                const data = this.data.weekly;
                if (!data) return;

                // Use safe array access
                const recs = this.safeArr(data.recommendations);
                
                const container = document.getElementById('recommendations-list');
                container.innerHTML = '';

                if (recs.length === 0) {
                    console.log(`COMMUNITY: Recommendations empty because length=${recs.length}`);
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-state';
                    emptyDiv.style.cssText = 'text-align: center; padding: 2rem; color: var(--fg-muted); font-style: italic;';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🤝</div>
                        <div>No recommendations yet. Check back soon as your network grows.</div>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }

                recs.forEach(rec => {
                    const div = document.createElement('div');
                    div.className = 'recommendation-card';
                    
                    // Safe access to recommendation properties
                    const name = rec.name || 'Unknown User';
                    const scores = rec.scores || {};
                    const total = Number.isFinite(scores.total) ? scores.total : 0;
                    const mutuals = this.safeArr(rec.mutuals);
                    const explain = rec.explain || 'No explanation available.';
                    
                    // Format mutuals display
                    const mutualsDisplay = mutuals.length > 0 
                        ? mutuals.slice(0, 3).join(', ') + (mutuals.length > 3 ? ` +${mutuals.length - 3} more` : '')
                        : 'No mutuals';
                    
                    div.innerHTML = `
                        <h4>${name}</h4>
                        <div class="recommendation-scores">
                            <span class="score-badge">${Math.round(total * 100)}% match</span>
                            <span class="score-badge">${mutualsDisplay}</span>
                        </div>
                        <p>${explain}</p>
                        <div class="recommendation-actions">
                            <button class="action-btn primary">Connect</button>
                            <button class="action-btn">View Profile</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            renderWarnings() {
                const data = this.data.weekly;
                if (!data || !data.warnings || data.warnings.length === 0) return;

                // Check if there's a geohash warning for geo expansion
                const hasGeohashWarning = data.warnings.some(warning => 
                    warning && warning.toLowerCase().includes('geohash')
                );

                // Add info note to geo expansion card if needed
                if (hasGeohashWarning) {
                    const geoCard = document.querySelector('.recap-card:nth-child(3)');
                    if (geoCard) {
                        const infoNote = document.createElement('div');
                        infoNote.style.cssText = 'font-size: 0.75rem; color: var(--fg-muted); margin-top: 0.5rem; font-style: italic;';
                        infoNote.textContent = 'Geo expansion unavailable (missing geohash on taps).';
                        geoCard.appendChild(infoNote);
                    }
                }

                // Show dismissible warning banner at bottom
                const warningBanner = document.createElement('div');
                warningBanner.className = 'warning-banner';
                warningBanner.style.cssText = `
                    position: fixed;
                    bottom: 1rem;
                    left: 1rem;
                    right: 1rem;
                    background: rgba(255, 193, 7, 0.1);
                    border: 1px solid rgba(255, 193, 7, 0.3);
                    border-radius: var(--radius-2);
                    padding: 0.75rem;
                    font-size: 0.875rem;
                    color: var(--fg-secondary);
                    z-index: 1000;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                warningBanner.innerHTML = `
                    <div>⚠️ ${data.warnings.join(' • ')}</div>
                    <button onclick="this.parentElement.remove()" style="
                        background: none; border: none; color: var(--fg-muted); 
                        cursor: pointer; font-size: 1.2rem; padding: 0.25rem;
                    ">×</button>
                `;
                
                document.body.appendChild(warningBanner);
            }

            updateLastUpdatedTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('last-updated-time').textContent = timeString;
            }

            async loadQuests() {
                console.log('🎯 [Quests] Loading quest data...');
                
                try {
                    const userId = this.currentUser?.user_id || this.currentUser?.id;
                    if (!userId) {
                        throw new Error('No user ID available');
                    }

                    const response = await fetch(`/api/community/quests?user_id=${userId}&debug=1`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('🎯 [Quests] Loaded:', data);
                    
                    this.renderQuests(data);
                    
                } catch (error) {
                    console.error('❌ [Quests] Failed to load:', error);
                    this.renderQuestsError(error);
                }
            }

            renderQuests(data) {
                console.log('🎯 [Quests] Rendering quests:', data);
                const content = document.getElementById('quests-content');
                console.log('🎯 [Quests] Content element:', content);
                
                if (!content) {
                    console.error('❌ [Quests] quests-content element not found!');
                    return;
                }
                
                if (!data.quests || data.quests.length === 0) {
                    console.log('🎯 [Quests] No quests data, showing empty state');
                    this.renderQuestsEmpty();
                    return;
                }
                
                console.log('🎯 [Quests] Found', data.quests.length, 'quests');
                
                // Update week info
                this.updateQuestsWeekInfo(data.week);
                
                // Sort quests by status: active → nearly done → completed
                const sortedQuests = this.sortQuestsByStatus(data.quests);
                console.log('🎯 [Quests] Sorted quests:', sortedQuests);
                
                const questsHTML = sortedQuests.map(quest => this.renderQuestCard(quest)).join('');
                console.log('🎯 [Quests] Generated HTML length:', questsHTML.length);
                
                content.innerHTML = `
                    <div class="quests-list">
                        ${questsHTML}
                    </div>
                `;

                console.log('🎯 [Quests] Content updated, innerHTML length:', content.innerHTML.length);

                // Debug: Check if quests section is visible
                const questsSection = document.getElementById('quests-section');
                if (questsSection) {
                    const computedStyle = window.getComputedStyle(questsSection);
                    console.log('🎯 [Quests] Section visibility:', {
                        display: computedStyle.display,
                        visibility: computedStyle.visibility,
                        opacity: computedStyle.opacity,
                        height: computedStyle.height,
                        width: computedStyle.width
                    });
                }

                // Debug: Check if quests container is visible
                const questsContainer = document.querySelector('.quests-container');
                if (questsContainer) {
                    const containerStyle = window.getComputedStyle(questsContainer);
                    console.log('🎯 [Quests] Container visibility:', {
                        display: containerStyle.display,
                        visibility: containerStyle.visibility,
                        opacity: containerStyle.opacity,
                        height: containerStyle.height,
                        width: containerStyle.width
                    });
                }

                // Setup refresh button
                this.setupQuestsRefresh();
            }

            sortQuestsByStatus(quests) {
                return quests.sort((a, b) => {
                    const statusA = this.getQuestStatus(a);
                    const statusB = this.getQuestStatus(b);
                    
                    // Sort order: active → nearly done → completed
                    const statusOrder = { 'active': 0, 'nearly-done': 1, 'completed': 2 };
                    return statusOrder[statusA] - statusOrder[statusB];
                });
            }

            getQuestStatus(quest) {
                const progress = quest.progress || 0;
                const target = quest.target || 0;
                
                if (target === 0) return 'active';
                if (progress >= target) return 'completed';
                if (progress >= target * 0.8) return 'nearly-done';
                return 'active';
            }

            renderQuestCard(quest) {
                const progress = quest.progress || 0;
                const target = quest.target || 0;
                const percentage = target > 0 ? Math.min(100, Math.round((progress / target) * 100)) : 0;
                const status = this.getQuestStatus(quest);
                
                const icon = this.getQuestIcon(quest.id);
                const statusText = this.getQuestStatusText(status, progress, target);
                const statusClass = this.getQuestStatusClass(status);
                
                return `
                    <div class="quest-card ${statusClass}" data-quest-id="${quest.id}">
                        <div class="quest-header">
                            <div class="quest-icon">${icon}</div>
                            <div class="quest-title">${quest.title}</div>
                        </div>
                        <div class="quest-progress">
                            <div class="progress-bar" role="progressbar" 
                                 aria-valuenow="${progress}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="${target}"
                                 aria-label="Progress: ${progress} of ${target} ${quest.unit}">
                                <div class="progress-fill ${this.getProgressClass(status, percentage)}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            <div class="progress-text">
                                <span>${progress} / ${target} ${quest.unit}</span>
                                <span class="progress-percentage">${percentage}%</span>
                            </div>
                        </div>
                        <div class="quest-status">
                            <div class="status-indicator ${statusClass}"></div>
                            <span>${statusText}</span>
                        </div>
                    </div>
                `;
            }

            getQuestIcon(questId) {
                const icons = {
                    'connect_5': '👥',
                    'taps_25': '📱',
                    'streak_3': '🔥'
                };
                return icons[questId] || '🎯';
            }

            getQuestStatusText(status, progress, target) {
                switch (status) {
                    case 'completed':
                        return 'Completed!';
                    case 'nearly-done':
                        return 'Almost there!';
                    case 'active':
                        return target === 0 ? 'Ready to start' : 'In progress';
                    default:
                        return 'In progress';
                }
            }

            getQuestStatusClass(status) {
                switch (status) {
                    case 'completed':
                        return 'completed';
                    case 'nearly-done':
                        return 'nearly-done';
                    case 'active':
                        return 'active';
                    default:
                        return 'active';
                }
            }

            getProgressClass(status, percentage) {
                if (status === 'completed') return 'completed';
                if (percentage > 100) return 'over-achieved';
                return '';
            }

            updateQuestsWeekInfo(week) {
                const weekInfo = document.getElementById('quests-week-info');
                if (week && week.year && week.iso_week) {
                    weekInfo.textContent = `Week ${week.iso_week}, ${week.year} (server week UTC, shown in your local time)`;
                } else {
                    weekInfo.textContent = 'Current week';
                }
            }

            renderQuestsEmpty() {
                const content = document.getElementById('quests-content');
                content.innerHTML = `
                    <div class="empty-state">
                        <div>🎯</div>
                        <div>No quests available</div>
                        <div style="font-size: var(--text-sm); margin-top: var(--space-2);">
                            Check back later for new challenges
                        </div>
                    </div>
                `;
            }

            renderQuestsError(error) {
                const content = document.getElementById('quests-content');
                content.innerHTML = `
                    <div class="error-state">
                        <div>❌</div>
                        <div>Failed to load quests</div>
                        <div style="font-size: var(--text-sm); margin-top: var(--space-2);">
                            ${error.message}
                        </div>
                        <button class="retry-button" onclick="location.reload()">
                            Retry
                        </button>
                    </div>
                `;
            }

            setupQuestsRefresh() {
                const refreshButton = document.getElementById('quests-refresh-button');
                if (refreshButton) {
                    refreshButton.onclick = () => this.refreshQuests();
                }
            }

            setupHealthRefresh() {
                const refreshButton = document.getElementById('health-refresh-button');
                if (refreshButton) {
                    refreshButton.onclick = () => this.refreshHealth();
                }
            }

            async refreshQuests() {
                const refreshButton = document.getElementById('quests-refresh-button');
                if (refreshButton) {
                    refreshButton.disabled = true;
                    refreshButton.textContent = '⟳';
                }
                
                try {
                    await this.loadQuests();
                } finally {
                    if (refreshButton) {
                        setTimeout(() => {
                            refreshButton.disabled = false;
                            refreshButton.textContent = '↻';
                        }, 1000);
                    }
                }
            }

            async refreshHealth() {
                const refreshButton = document.getElementById('health-refresh-button');
                if (refreshButton) {
                    refreshButton.disabled = true;
                    refreshButton.textContent = '⟳';
                }
                
                try {
                    await this.loadHealth();
                } finally {
                    if (refreshButton) {
                        setTimeout(() => {
                            refreshButton.disabled = false;
                            refreshButton.textContent = '↻';
                        }, 1000);
                    }
                }
            }

            async loadRadar() {
                console.log('📡 [Radar] Loading radar data...');
                
                try {
                    const userId = this.currentUser?.user_id || this.currentUser?.id;
                    if (!userId) {
                        throw new Error('No user ID available');
                    }

                    const response = await fetch(`/api/community/radar?user_id=${userId}&hours=120&debug=1`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('📡 [Radar] Loaded:', data);
                    
                    this.renderRadar(data);
                    
                } catch (error) {
                    console.error('❌ [Radar] Failed to load:', error);
                    this.renderRadarError(error);
                }
            }

            renderRadar(data) {
                console.log('📡 [Radar] Rendering radar:', data);
                const content = document.getElementById('radar-content');
                console.log('📡 [Radar] Content element:', content);
                
                if (!content) {
                    console.error('❌ [Radar] radar-content element not found!');
                    return;
                }
                
                if (!data.buckets || data.buckets.length === 0) {
                    console.log('📡 [Radar] No activity data, showing empty state');
                    this.renderRadarEmpty();
                    return;
                }
                
                console.log('📡 [Radar] Found', data.buckets.length, 'activity buckets');
                
                // Update timezone info
                this.updateRadarTimezoneInfo(data.meta);
                
                // Generate activity timeline
                const timelineHTML = this.renderActivityTimeline(data.buckets);
                
                // Generate participants section
                const participantsHTML = this.renderParticipants(data.top_current_window || []);
                
                // Check for surge indicators
                const surgeHTML = this.renderSurgeIndicators(data.buckets);
                
                content.innerHTML = `
                    ${surgeHTML}
                    <div class="activity-timeline">
                        ${timelineHTML}
                    </div>
                    <div class="participants-section">
                        <h3>Top Participants</h3>
                        <div class="participants-grid">
                            ${participantsHTML}
                        </div>
                    </div>
                `;

                console.log('📡 [Radar] Content updated, innerHTML length:', content.innerHTML.length);
            }

            renderActivityTimeline(buckets) {
                return buckets.map((bucket, index) => {
                    const hour = new Date(bucket.ts).getHours();
                    const activityCount = bucket.activity_count || 0;
                    const activityLevel = this.getActivityLevel(activityCount);
                    const tooltip = `${hour}:00: ${activityCount} activities`;
                    
                    return `
                        <div class="hour-bucket ${activityLevel}" title="${tooltip}">
                            ${hour}
                        </div>
                    `;
                }).join('');
            }

            getActivityLevel(count) {
                if (count === 0) return 'low';
                if (count < 5) return 'medium';
                if (count < 10) return 'high';
                return 'surge';
            }

            renderParticipants(participants) {
                if (!participants || participants.length === 0) {
                    return '<div class="empty-state">No recent participants</div>';
                }
                
                return participants.slice(0, 6).map(participant => `
                    <div class="participant-card">
                        <div class="participant-name">${participant.name || participant.user_id || 'Unknown'}</div>
                        <div class="participant-activity">${participant.activity_count || 0} activities</div>
                    </div>
                `).join('');
            }

            renderSurgeIndicators(buckets) {
                const surgeHours = buckets
                    .map(bucket => ({ 
                        hour: new Date(bucket.ts).getHours(), 
                        count: bucket.activity_count || 0 
                    }))
                    .filter(h => h.count >= 10)
                    .slice(0, 3);
                
                if (surgeHours.length === 0) {
                    return '';
                }
                
                const surgeText = surgeHours.length === 1 
                    ? `Activity surge at ${surgeHours[0].hour}:00`
                    : `Activity surges at ${surgeHours.map(h => `${h.hour}:00`).join(', ')}`;
                
                return `
                    <div class="surge-indicator">
                        🔥 ${surgeText}
                    </div>
                `;
            }

            updateRadarTimezoneInfo(meta) {
                const timezoneInfo = document.getElementById('radar-timezone-info');
                if (meta && meta.tz_used) {
                    timezoneInfo.textContent = `Timezone: ${meta.tz_used}`;
                } else {
                    timezoneInfo.textContent = 'Timezone: UTC';
                }
            }

            renderRadarEmpty() {
                const content = document.getElementById('radar-content');
                content.innerHTML = `
                    <div class="empty-state">
                        <div>📡</div>
                        <div>No activity data available</div>
                        <div style="font-size: var(--text-sm); margin-top: var(--space-2);">
                            Check back later for network activity
                        </div>
                    </div>
                `;
            }

            renderRadarError(error) {
                const content = document.getElementById('radar-content');
                content.innerHTML = `
                    <div class="error-state">
                        <div>❌</div>
                        <div>Failed to load radar data</div>
                        <div style="font-size: var(--text-sm); margin-top: var(--space-2);">
                            ${error.message}
                        </div>
                        <button class="retry-button" onclick="location.reload()">
                            Retry
                        </button>
                    </div>
                `;
            }

        }

        // Initialize the community page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.communityPage = new CommunityPage();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Community - ARC Social Graph</title>
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --fg-primary: #ffffff;
            --fg-secondary: #cccccc;
            --fg-muted: #888888;
            --accent: #007bff;
            --accent-hover: #0056b3;
            --stroke: #333333;
            --radius: 8px;
            --radius-2: 4px;
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Disable zoom but allow scrolling */
        html {
            touch-action: pan-y;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--fg-primary);
            overflow-y: auto;
            overflow-x: hidden;
            height: 100vh;
        }

        .main-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Community Page Styles */
        .community-page {
            background: var(--bg-primary);
            color: var(--fg-primary);
            min-height: 100vh;
            padding: var(--space-4);
            overflow-y: auto;
        }

        .community-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
        }

        .community-header h1 {
            font-size: var(--text-3xl);
            font-weight: 600;
            color: var(--fg-primary);
        }

        .last-updated {
            font-size: var(--text-sm);
            color: var(--fg-muted);
        }

        /* Navigation Tabs */
        .community-nav {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            border-bottom: 1px solid var(--stroke);
        }

        .nav-tab {
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .nav-tab.active {
            color: var(--fg-primary);
            border-bottom-color: var(--accent);
        }

        .nav-tab:hover {
            color: var(--fg-primary);
        }

        /* Recap Cards */
        .recap-strip {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .recap-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            padding: var(--space-4);
            text-align: center;
        }

        .recap-card h3 {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            margin-bottom: var(--space-2);
        }

        .recap-value {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--fg-primary);
        }

        /* Momentum Ring */
        .momentum-section {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-8);
        }

        .momentum-ring {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--accent) 0deg, var(--stroke) 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring-progress {
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border-radius: 50%;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ring-text {
            text-align: center;
        }

        .streak-days {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--accent);
        }

        .streak-label {
            font-size: var(--text-xs);
            color: var(--fg-muted);
        }

        /* Leaderboard */
        .leaderboard-section {
            margin-bottom: var(--space-8);
        }

        .leaderboard-nav {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .leaderboard-tab {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-1);
            color: var(--fg-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .leaderboard-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--stroke);
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        /* Recommendations */
        .recommendations-section {
            margin-bottom: var(--space-8);
        }

        .recommendations-carousel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-4);
        }

        .recommendation-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            padding: var(--space-4);
        }

        .recommendation-card h4 {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-2);
        }

        .recommendation-scores {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .score-badge {
            padding: var(--space-1) var(--space-2);
            background: var(--accent);
            color: var(--bg-primary);
            border-radius: var(--radius-1);
            font-size: var(--text-xs);
            font-weight: 500;
        }

        .recommendation-actions {
            display: flex;
            gap: var(--space-2);
        }

        .action-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--bg-primary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius-1);
            color: var(--fg-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }

        .action-btn.primary {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .community-page {
                padding: var(--space-2);
            }
            
            .recap-strip {
                grid-template-columns: 1fr;
            }
            
            .recommendations-carousel {
                grid-template-columns: 1fr;
            }
            
            .community-nav {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1;
                min-width: 0;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--accent);
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--stroke);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: var(--space-4);
        }

        .loading-state p {
            color: var(--fg-muted);
            font-size: var(--text-sm);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--fg-muted);
            font-style: italic;
        }

        .empty-state div:first-child {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.6;
        }

        /* Error States */
        .error-state {
            text-align: center;
            padding: 2rem;
            color: var(--fg-muted);
        }

        .error-state h3 {
            color: var(--accent);
            margin-bottom: 1rem;
        }

        .retry-btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-2);
            cursor: pointer;
            margin-top: 1rem;
        }

        .retry-btn:hover {
            background: var(--accent-hover);
        }

        /* Warning Banner */
        .warning-banner {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Quests Section Styles */
        .quests-container {
            padding: var(--space-4);
            max-width: 600px;
            margin: 0 auto;
        }

        .quests-header {
            margin-bottom: var(--space-6);
        }

        .quests-header h2 {
            font-size: var(--text-3xl);
            font-weight: 600;
            color: var(--fg-primary);
            margin-bottom: var(--space-2);
        }

        .quests-subtitle {
            font-size: var(--text-sm);
            color: var(--fg-muted);
            margin-bottom: var(--space-4);
        }

        .week-info {
            font-size: var(--text-xs);
            color: var(--fg-muted);
            background: var(--bg-secondary);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-2);
            display: inline-block;
        }

        .quests-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .quest-card {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: var(--space-4);
            transition: all 0.2s ease;
        }

        .quest-card:hover {
            border-color: var(--accent);
        }

        .quest-card.completed {
            border-color: var(--success);
        }

        .quest-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .quest-icon {
            font-size: var(--text-xl);
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-2);
        }

        .quest-title {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--fg-primary);
        }

        .quest-progress {
            margin-bottom: var(--space-3);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-2);
            overflow: hidden;
            margin-bottom: var(--space-2);
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: var(--radius-2);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-fill.completed {
            background: var(--success);
        }

        .progress-fill.over-achieved {
            background: var(--warning);
        }

        .progress-text {
            font-size: var(--text-sm);
            color: var(--fg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-percentage {
            font-weight: 600;
            color: var(--fg-primary);
        }

        .quest-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--fg-muted);
        }

        .status-indicator.completed {
            background: var(--success);
        }

        .status-indicator.in-progress {
            background: var(--accent);
        }

        .status-indicator.not-started {
            background: var(--fg-muted);
        }

        .refresh-button {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            color: var(--fg-secondary);
            padding: var(--space-2);
            border-radius: var(--radius-2);
            cursor: pointer;
            font-size: var(--text-sm);
            transition: all 0.2s ease;
        }

        .refresh-button:hover {
            background: var(--bg-tertiary);
            color: var(--fg-primary);
        }

        .refresh-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .routes-placeholder {
            background: var(--bg-secondary);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: var(--space-4);
            margin-top: var(--space-6);
            text-align: center;
            color: var(--fg-muted);
        }

        .routes-placeholder h3 {
            font-size: var(--text-lg);
            margin-bottom: var(--space-2);
            color: var(--fg-secondary);
        }

        .routes-placeholder p {
            font-size: var(--text-sm);
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            .progress-fill {
                transition: none;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="content-area">
            <div id="community-container" class="community-page">
                <!-- Header -->
                <div class="community-header">
                    <h1>Community</h1>
                    <div class="last-updated">Last updated at <span id="last-updated-time"></span></div>
                </div>

                <!-- Navigation Tabs -->
                <div class="community-nav">
                    <button class="nav-tab active" data-section="pulse">Weekly Pulse</button>
                    <button class="nav-tab" data-section="quests">Quests & Routes</button>
                    <button class="nav-tab" data-section="radar">Opportunity Radar</button>
                    <button class="nav-tab" data-section="health">Relationship Health</button>
                </div>

                <!-- Content Sections -->
                <div class="community-content">
                        <!-- Weekly Pulse Section -->
                        <div id="pulse-section" class="community-section active">
                            <!-- Loading State -->
                            <div id="loading-state" class="loading-state">
                                <div class="loading-spinner"></div>
                                <p>Loading your community data...</p>
                            </div>
                            
                            <!-- Content (hidden initially) -->
                            <div id="content-state" style="display: none;">
                                <!-- Recap Cards -->
                                <div class="recap-strip">
                                    <div class="recap-card">
                                        <h3>New Connections</h3>
                                        <div class="recap-value" id="new-connections-count">-</div>
                                    </div>
                                    <div class="recap-card">
                                        <h3>Network Growth</h3>
                                        <div class="recap-value" id="network-growth-count">-</div>
                                    </div>
                                    <div class="recap-card">
                                        <h3>Community Activity</h3>
                                        <div class="recap-value" id="community-activity-count">-</div>
                                    </div>
                                </div>

                        <!-- Momentum Ring -->
                        <div class="momentum-section">
                            <div class="momentum-ring">
                                <div class="ring-progress" id="weekly-goal-progress"></div>
                                <div class="ring-text">
                                    <div class="streak-days" id="current-streak">-</div>
                                    <div class="streak-label">day streak</div>
                                </div>
                            </div>
                        </div>

                        <!-- Leaderboard Tabs -->
                        <div class="leaderboard-section">
                            <div class="leaderboard-nav">
                                <button class="leaderboard-tab active" data-leaderboard="connectors">Top Connectors</button>
                                <button class="leaderboard-tab" data-leaderboard="reach">Expanding Reach</button>
                                <button class="leaderboard-tab" data-leaderboard="consistency">Consistency</button>
                            </div>
                            <div class="leaderboard-content" id="leaderboard-list"></div>
                        </div>

                        <!-- Recommendations -->
                        <div class="recommendations-section">
                            <h3>People You Should Meet</h3>
                            <div class="recommendations-carousel" id="recommendations-list"></div>
                        </div>
                    </div>

                    <!-- Other sections will be added here -->
                    <div id="quests-section" class="community-section" style="display: none;">
                        <div class="quests-container">
                            <div class="quests-header">
                                <h2>Quests & Routes</h2>
                                <div class="quests-subtitle">Complete weekly challenges to grow your network</div>
                                <div class="week-info" id="quests-week-info">Loading week info...</div>
                            </div>

                            <button class="refresh-button" id="quests-refresh-button" title="Refresh quests">
                                ↻
                            </button>

                            <div id="quests-content">
                                <div class="loading-state">
                                    <div class="loading-spinner"></div>
                                    <div>Loading quests...</div>
                                </div>
                            </div>

                            <div class="routes-placeholder">
                                <h3>Routes</h3>
                                <p>Personalized connection suggestions coming soon</p>
                            </div>
                        </div>
                    </div>

                    <div id="radar-section" class="community-section" style="display: none;">
                        <h2>Opportunity Radar</h2>
                        <p>Live activity radar coming soon...</p>
                    </div>

                    <div id="health-section" class="community-section" style="display: none;">
                        <h2>Relationship Health</h2>
                        <p>Relationship management coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Community Page JavaScript
        class CommunityPage {
            constructor() {
                this.currentUser = null;
                this.currentSection = 'pulse';
                this.data = {};
                this.init();
            }

            // Helper function for safe array access
            safeArr(v) { 
                return Array.isArray(v) ? v : []; 
            }

            // Validation helper for weekly payload
            validateWeeklyPayload(data) {
                const warnings = [];
                const errors = [];

                // Check required top-level fields
                if (!data) {
                    errors.push('Payload is null/undefined');
                    return { valid: false, errors, warnings };
                }

                if (!data.source) warnings.push('Missing source field');
                if (!data.week) errors.push('Missing week object');
                if (!data.recap) errors.push('Missing recap object');
                if (!data.momentum) errors.push('Missing momentum object');
                if (!data.leaderboard) errors.push('Missing leaderboard object');
                if (!data.meta) errors.push('Missing meta object');

                // Check recap structure
                if (data.recap) {
                    if (!Array.isArray(data.recap.first_degree_new)) warnings.push('recap.first_degree_new should be array');
                    if (typeof data.recap.second_degree_delta !== 'number') warnings.push('recap.second_degree_delta should be number');
                    if (!Array.isArray(data.recap.community_activity)) warnings.push('recap.community_activity should be array');
                    if (!Array.isArray(data.recap.geo_expansion)) warnings.push('recap.geo_expansion should be array');
                }

                // Check momentum structure
                if (data.momentum) {
                    if (typeof data.momentum.current_streak_days !== 'number') warnings.push('momentum.current_streak_days should be number');
                    if (typeof data.momentum.longest_streak_days !== 'number') warnings.push('momentum.longest_streak_days should be number');
                    if (typeof data.momentum.weekly_taps !== 'number') warnings.push('momentum.weekly_taps should be number');
                    if (typeof data.momentum.new_connections !== 'number') warnings.push('momentum.new_connections should be number');
                    if (!data.momentum.weekly_goal) warnings.push('Missing momentum.weekly_goal');
                    if (data.momentum.weekly_goal) {
                        if (typeof data.momentum.weekly_goal.progress !== 'number') warnings.push('momentum.weekly_goal.progress should be number');
                        if (typeof data.momentum.weekly_goal.target_taps !== 'number') warnings.push('momentum.weekly_goal.target_taps should be number');
                    }
                }

                // Check leaderboard structure
                if (data.leaderboard) {
                    if (!Array.isArray(data.leaderboard.new_connections)) warnings.push('leaderboard.new_connections should be array');
                    if (!Array.isArray(data.leaderboard.community_builders)) warnings.push('leaderboard.community_builders should be array');
                    if (!Array.isArray(data.leaderboard.streak_masters)) warnings.push('leaderboard.streak_masters should be array');
                }

                // Check recommendations
                if (!Array.isArray(data.recommendations)) warnings.push('recommendations should be array');

                // Check meta structure
                if (data.meta) {
                    if (!data.meta.source) warnings.push('Missing meta.source');
                    if (typeof data.meta.duration_ms !== 'number') warnings.push('meta.duration_ms should be number');
                    if (!data.meta.user_id) warnings.push('Missing meta.user_id');
                    if (!data.meta.watermark) warnings.push('Missing meta.watermark');
                    if (!Array.isArray(data.meta.warnings)) warnings.push('meta.warnings should be array');
                }

                const valid = errors.length === 0;
                
                if (!valid || warnings.length > 0) {
                    console.warn('COMMUNITY: Weekly payload validation issues:', {
                        valid,
                        errors,
                        warnings,
                        payloadKeys: Object.keys(data || {}),
                        source: data?.source || 'unknown'
                    });
                }

                return { valid, errors, warnings };
            }

        async init() {
            // Set up event listeners first
            this.setupEventListeners();
            
            // Wait for authentication to complete
            await this.waitForAuthentication();
            
            // Load initial data
            await this.loadWeeklyPulse();
            
            // Update last updated time
            this.updateLastUpdatedTime();
        }

        async waitForAuthentication() {
            // Wait for authentication to complete (max 10 seconds)
            const maxWaitTime = 10000;
            const checkInterval = 100;
            let waitTime = 0;

            while (waitTime < maxWaitTime) {
                this.currentUser = this.getCurrentUser();
                if (this.currentUser) {
                    console.log('✅ User authenticated:', this.currentUser.name);
                    return;
                }
                
                // Wait a bit and check again
                await new Promise(resolve => setTimeout(resolve, checkInterval));
                waitTime += checkInterval;
            }

            // If we get here, authentication failed
            console.error('❌ Authentication timeout - using mock data');
            this.currentUser = {
                user_id: 'mock-user-id',
                name: 'Demo User'
            };
        }

            getCurrentUser() {
                try {
                    const stored = sessionStorage.getItem('authenticatedUser');
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    console.error('Error parsing stored user:', error);
                    return null;
                }
            }

            setupEventListeners() {
                // Navigation tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        this.switchSection(section);
                    });
                });

                // Leaderboard tabs
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const leaderboard = e.target.dataset.leaderboard;
                        this.switchLeaderboard(leaderboard);
                    });
                });
            }

            switchSection(section) {
                console.log('🔄 [Community] Switching to section:', section);
                
                // Update nav tabs
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-section="${section}"]`).classList.add('active');

                // Update content sections
                document.querySelectorAll('.community-section').forEach(sec => {
                    sec.style.display = 'none';
                });
                
                const targetSection = document.getElementById(`${section}-section`);
                console.log('🔄 [Community] Target section element:', targetSection);
                
                if (targetSection) {
                    targetSection.style.display = 'block';
                    console.log('🔄 [Community] Section displayed');
                } else {
                    console.error('❌ [Community] Section not found:', `${section}-section`);
                }

                // Load section-specific data
                if (section === 'quests') {
                    console.log('🔄 [Community] Loading quests...');
                    this.loadQuests();
                } else if (section === 'radar') {
                    this.loadRadar();
                } else if (section === 'health') {
                    this.loadHealth();
                }

                this.currentSection = section;

                // Load section data
                this.loadSectionData(section);
            }

            switchLeaderboard(leaderboard) {
                // Update leaderboard tabs
                document.querySelectorAll('.leaderboard-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-leaderboard="${leaderboard}"]`).classList.add('active');

                // Update leaderboard content
                this.renderLeaderboard(leaderboard);
            }

            async loadSectionData(section) {
                switch (section) {
                    case 'pulse':
                        await this.loadWeeklyPulse();
                        break;
                    case 'quests':
                        await this.loadQuests();
                        break;
                    case 'radar':
                        await this.loadRadar();
                        break;
                    case 'health':
                        await this.loadHealth();
                        break;
                }
            }

            async loadWeeklyPulse() {
                try {
                    console.log('🔄 Loading weekly pulse for user:', this.currentUser.user_id);
                    const response = await fetch(`/api/community/weekly?user_id=${this.currentUser.user_id}`);
                    console.log('📡 API response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const responseData = await response.json();
                    console.log('📊 API response data:', responseData);
                    console.log('Community payload source:', responseData?.source || 'unknown');
                    
                    // Validate payload structure
                    this.validateWeeklyPayload(responseData);
                    
                    // Normalize data with safe access patterns
                    const data = responseData || {};
                    const recap = data?.recap ?? {};
                    const momentum = data?.momentum ?? {};
                    const leaderboard = data?.leaderboard ?? {};
                    const recommendations = this.safeArr(data?.recommendations);
                    const warnings = this.safeArr(data?.meta?.warnings);
                    
                    // Normalize arrays used in loops
                    const firstDegree = this.safeArr(recap.first_degree_new);
                    const communityActivity = this.safeArr(recap.community_activity);
                    const geoExpansion = this.safeArr(recap.geo_expansion);
                    const newConnections = this.safeArr(leaderboard.new_connections);
                    const communityBuilders = this.safeArr(leaderboard.community_builders);
                    const streakMasters = this.safeArr(leaderboard.streak_masters);
                    
                    // Store normalized data
                    this.data.weekly = {
                        ...data,
                        recap: {
                            ...recap,
                            first_degree_new: firstDegree,
                            community_activity: communityActivity,
                            geo_expansion: geoExpansion
                        },
                        momentum,
                        leaderboard: {
                            new_connections: newConnections,
                            community_builders: communityBuilders,
                            streak_masters: streakMasters
                        },
                        recommendations,
                        warnings
                    };
                    
                    this.renderWeeklyPulse();
                } catch (error) {
                    console.error('Error loading weekly pulse:', error);
                    // Only fallback to mock if explicitly enabled via URL parameter
                    const urlParams = new URLSearchParams(window.location.search);
                    const useMock = urlParams.get('mock') === '1';
                    
                    if (useMock) {
                        console.log('Using mock data (explicitly enabled via ?mock=1)');
                        this.loadMockData();
                    } else {
                        // Show UI error instead of mock data
                        this.showUIError('Failed to load community data. Please try again.');
                    }
                }
            }

            showUIError(message) {
                console.log('📊 Showing UI error:', message);
                
                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';
                
                // Show error message in the main content area
                const contentState = document.getElementById('content-state');
                contentState.innerHTML = `
                    <div class="error-state">
                        <h3>⚠️ Unable to Load Community Data</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" class="retry-btn">Retry</button>
                    </div>
                `;
            }

            renderEmptyWeeklyState() {
                console.log('📊 Rendering empty weekly state due to data structure issues');
                
                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';
                
                // Set all values to zero/empty
                document.getElementById('new-connections-count').textContent = '0';
                document.getElementById('network-growth-count').textContent = '0';
                document.getElementById('community-activity-count').textContent = '0';
                document.getElementById('current-streak').textContent = '0';
                
                // Show error message
                const contentState = document.getElementById('content-state');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = '<p>⚠️ Unable to load community data. Please try refreshing the page.</p>';
                contentState.appendChild(errorDiv);
            }

            async loadQuests() {
                console.log('Loading quests...');
                // TODO: Implement quests loading
            }

            async loadRadar() {
                console.log('Loading radar...');
                // TODO: Implement radar loading
            }

            async loadHealth() {
                console.log('Loading health...');
                // TODO: Implement health loading
            }

            loadMockData() {
                // Use mock data for development
                this.data.weekly = {
                    recap: {
                        first_degree_new: [
                            { user_id: "u123", name: "Grace Brown", last_tap_at: "2025-01-15T18:12:00Z" },
                            { user_id: "u456", name: "Owen Chen", last_tap_at: "2025-01-14T14:30:00Z" }
                        ],
                        second_degree_delta: 22,
                        community_activity: [
                            { community_id: "c7", name: "Nashville Founders", tap_count: 31, unique_users: 14 }
                        ],
                        geo_expansion: [
                            { city: "Austin", new_taps: 5 }
                        ]
                    },
                    momentum: {
                        current_streak_days: 9,
                        longest_streak_days: 17,
                        weekly_goal: { target_taps: 5, progress: 4 }
                    },
                    leaderboard: {
                        new_connections: [
                            { user_id: "u321", name: "Owen", new_first_degree: 6 }
                        ],
                        community_builders: [
                            { user_id: "u555", name: "Mia", delta_second_degree: 18 }
                        ],
                        streak_masters: [
                            { user_id: "u789", name: "Alex", streak_days: 21 }
                        ]
                    },
                    recommendations: [
                        {
                            user_id: "u999",
                            name: "Alex Fielding",
                            mutuals: 3,
                            scores: { total: 0.69 },
                            explain: "Shared strong mutuals with Grace & Owen; also in Nashville."
                        }
                    ]
                };
                this.renderWeeklyPulse();
            }

            renderWeeklyPulse() {
                const data = this.data.weekly;
                if (!data) return;

                // Debug logging (only if debug=1)
                const urlParams = new URLSearchParams(window.location.search);
                const isDebug = urlParams.get('debug') === '1';
                
                if (isDebug) {
                    console.log('🔍 Weekly data received:', data);
                    console.log('🔍 Data.recap:', data.recap);
                    console.log('🔍 Data.recap.first_degree_new:', data.recap?.first_degree_new);
                    console.log('🔍 Data.meta:', data.meta);
                }
                
                // Display meta information for debugging
                if (data.meta && isDebug) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'data-status';
                    statusDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 12px; z-index: 1000;';
                    statusDiv.innerHTML = `
                        <div>Source: ${data.meta.source}</div>
                        <div>Duration: ${data.meta.duration_ms}ms</div>
                        <div>Watermark: ${new Date(data.meta.watermark).toLocaleTimeString()}</div>
                    `;
                    document.body.appendChild(statusDiv);
                }

                // Hide loading state and show content
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('content-state').style.display = 'block';

                // Update recap cards with safe array access
                const newConnectionsCount = this.safeArr(data.recap?.first_degree_new).length;
                const networkGrowthCount = data.recap?.second_degree_delta || 0;
                const communityActivityCount = this.safeArr(data.recap?.community_activity).length;
                
                console.log(`COMMUNITY: Recap cards - new_connections:${newConnectionsCount}, network_growth:${networkGrowthCount}, community_activity:${communityActivityCount}`);
                
                document.getElementById('new-connections-count').textContent = newConnectionsCount;
                document.getElementById('network-growth-count').textContent = networkGrowthCount;
                document.getElementById('community-activity-count').textContent = communityActivityCount;

                // Update momentum ring
                document.getElementById('current-streak').textContent = data.momentum?.current_streak_days || 0;
                
                // Update weekly goal progress with null-safety
                const wg = data.momentum?.weekly_goal ?? {};
                const wgProgress = Number.isFinite(wg.progress) ? wg.progress : 0;
                const wgTarget = Number.isFinite(wg.target_taps) && wg.target_taps > 0 ? wg.target_taps : 25;
                const wgPct = Math.max(0, Math.min(100, (wgTarget ? (wgProgress / wgTarget) * 100 : 0)));
                
                const ring = document.getElementById('weekly-goal-progress');
                ring.style.background = `conic-gradient(var(--accent) ${wgPct * 3.6}deg, var(--stroke) 0deg)`;

                // Render leaderboard
                this.renderLeaderboard('connectors');

                // Render recommendations
                this.renderRecommendations();
                
                // Render warnings if present
                this.renderWarnings();
            }

            renderLeaderboard(type) {
                const data = this.data.weekly;
                if (!data) return;

                // Use safe array access
                const newConnections = this.safeArr(data.leaderboard?.new_connections);
                const communityBuilders = this.safeArr(data.leaderboard?.community_builders);
                const streakMasters = this.safeArr(data.leaderboard?.streak_masters);

                // Map type to appropriate array
                let leaderboardData = [];
                let emptyMessage = '';
                
                if (type === 'connectors') {
                    leaderboardData = newConnections;
                    emptyMessage = 'No new connections ranked yet this week.';
                } else if (type === 'reach') {
                    leaderboardData = communityBuilders;
                    emptyMessage = 'No high-activity builders yet this week.';
                } else {
                    leaderboardData = streakMasters;
                    emptyMessage = 'No active streaks to show yet.';
                }
                
                const container = document.getElementById('leaderboard-list');
                container.innerHTML = '';

                if (leaderboardData.length === 0) {
                    console.log(`COMMUNITY: Leaderboard:${type} empty because length=${leaderboardData.length}`);
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-state';
                    emptyDiv.style.cssText = 'text-align: center; padding: 2rem; color: var(--fg-muted); font-style: italic;';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">📊</div>
                        <div>${emptyMessage}</div>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }

                leaderboardData.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-item';
                    div.innerHTML = `
                        <div>
                            <strong>${index + 1}. ${item.name || 'Unknown'}</strong>
                        </div>
                        <div>
                            ${type === 'connectors' ? (item.new_first_degree || 0) + ' new' :
                              type === 'reach' ? '+' + (item.delta_second_degree || 0) + ' reach' :
                              (item.streak_days || 0) + ' days'}
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            renderRecommendations() {
                const data = this.data.weekly;
                if (!data) return;

                // Use safe array access
                const recs = this.safeArr(data.recommendations);
                
                const container = document.getElementById('recommendations-list');
                container.innerHTML = '';

                if (recs.length === 0) {
                    console.log(`COMMUNITY: Recommendations empty because length=${recs.length}`);
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'empty-state';
                    emptyDiv.style.cssText = 'text-align: center; padding: 2rem; color: var(--fg-muted); font-style: italic;';
                    emptyDiv.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🤝</div>
                        <div>No recommendations yet. Check back soon as your network grows.</div>
                    `;
                    container.appendChild(emptyDiv);
                    return;
                }

                recs.forEach(rec => {
                    const div = document.createElement('div');
                    div.className = 'recommendation-card';
                    
                    // Safe access to recommendation properties
                    const name = rec.name || 'Unknown User';
                    const scores = rec.scores || {};
                    const total = Number.isFinite(scores.total) ? scores.total : 0;
                    const mutuals = this.safeArr(rec.mutuals);
                    const explain = rec.explain || 'No explanation available.';
                    
                    // Format mutuals display
                    const mutualsDisplay = mutuals.length > 0 
                        ? mutuals.slice(0, 3).join(', ') + (mutuals.length > 3 ? ` +${mutuals.length - 3} more` : '')
                        : 'No mutuals';
                    
                    div.innerHTML = `
                        <h4>${name}</h4>
                        <div class="recommendation-scores">
                            <span class="score-badge">${Math.round(total * 100)}% match</span>
                            <span class="score-badge">${mutualsDisplay}</span>
                        </div>
                        <p>${explain}</p>
                        <div class="recommendation-actions">
                            <button class="action-btn primary">Connect</button>
                            <button class="action-btn">View Profile</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            renderWarnings() {
                const data = this.data.weekly;
                if (!data || !data.warnings || data.warnings.length === 0) return;

                // Check if there's a geohash warning for geo expansion
                const hasGeohashWarning = data.warnings.some(warning => 
                    warning && warning.toLowerCase().includes('geohash')
                );

                // Add info note to geo expansion card if needed
                if (hasGeohashWarning) {
                    const geoCard = document.querySelector('.recap-card:nth-child(3)');
                    if (geoCard) {
                        const infoNote = document.createElement('div');
                        infoNote.style.cssText = 'font-size: 0.75rem; color: var(--fg-muted); margin-top: 0.5rem; font-style: italic;';
                        infoNote.textContent = 'Geo expansion unavailable (missing geohash on taps).';
                        geoCard.appendChild(infoNote);
                    }
                }

                // Show dismissible warning banner at bottom
                const warningBanner = document.createElement('div');
                warningBanner.className = 'warning-banner';
                warningBanner.style.cssText = `
                    position: fixed;
                    bottom: 1rem;
                    left: 1rem;
                    right: 1rem;
                    background: rgba(255, 193, 7, 0.1);
                    border: 1px solid rgba(255, 193, 7, 0.3);
                    border-radius: var(--radius-2);
                    padding: 0.75rem;
                    font-size: 0.875rem;
                    color: var(--fg-secondary);
                    z-index: 1000;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                warningBanner.innerHTML = `
                    <div>⚠️ ${data.warnings.join(' • ')}</div>
                    <button onclick="this.parentElement.remove()" style="
                        background: none; border: none; color: var(--fg-muted); 
                        cursor: pointer; font-size: 1.2rem; padding: 0.25rem;
                    ">×</button>
                `;
                
                document.body.appendChild(warningBanner);
            }

            updateLastUpdatedTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('last-updated-time').textContent = timeString;
            }

            async loadQuests() {
                console.log('🎯 [Quests] Loading quest data...');
                
                try {
                    const userId = this.currentUser?.user_id || this.currentUser?.id;
                    if (!userId) {
                        throw new Error('No user ID available');
                    }

                    const response = await fetch(`/api/community/quests?user_id=${userId}&debug=1`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('🎯 [Quests] Loaded:', data);
                    
                    this.renderQuests(data);
                    
                } catch (error) {
                    console.error('❌ [Quests] Failed to load:', error);
                    this.renderQuestsError(error);
                }
            }

            renderQuests(data) {
                console.log('🎯 [Quests] Rendering quests:', data);
                const content = document.getElementById('quests-content');
                console.log('🎯 [Quests] Content element:', content);
                
                if (!content) {
                    console.error('❌ [Quests] quests-content element not found!');
                    return;
                }
                
                if (!data.quests || data.quests.length === 0) {
                    console.log('🎯 [Quests] No quests data, showing empty state');
                    this.renderQuestsEmpty();
                    return;
                }
                
                console.log('🎯 [Quests] Found', data.quests.length, 'quests');
                
                // Update week info
                this.updateQuestsWeekInfo(data.week);
                
                // Sort quests by status: active → nearly done → completed
                const sortedQuests = this.sortQuestsByStatus(data.quests);
                console.log('🎯 [Quests] Sorted quests:', sortedQuests);
                
                const questsHTML = sortedQuests.map(quest => this.renderQuestCard(quest)).join('');
                console.log('🎯 [Quests] Generated HTML length:', questsHTML.length);
                
                content.innerHTML = `
                    <div class="quests-list">
                        ${questsHTML}
                    </div>
                `;

                console.log('🎯 [Quests] Content updated, innerHTML length:', content.innerHTML.length);

                // Setup refresh button
                this.setupQuestsRefresh();
            }

            sortQuestsByStatus(quests) {
                return quests.sort((a, b) => {
                    const statusA = this.getQuestStatus(a);
                    const statusB = this.getQuestStatus(b);
                    
                    // Sort order: active → nearly done → completed
                    const statusOrder = { 'active': 0, 'nearly-done': 1, 'completed': 2 };
                    return statusOrder[statusA] - statusOrder[statusB];
                });
            }

            getQuestStatus(quest) {
                const progress = quest.progress || 0;
                const target = quest.target || 0;
                
                if (target === 0) return 'active';
                if (progress >= target) return 'completed';
                if (progress >= target * 0.8) return 'nearly-done';
                return 'active';
            }

            renderQuestCard(quest) {
                const progress = quest.progress || 0;
                const target = quest.target || 0;
                const percentage = target > 0 ? Math.min(100, Math.round((progress / target) * 100)) : 0;
                const status = this.getQuestStatus(quest);
                
                const icon = this.getQuestIcon(quest.id);
                const statusText = this.getQuestStatusText(status, progress, target);
                const statusClass = this.getQuestStatusClass(status);
                
                return `
                    <div class="quest-card ${statusClass}" data-quest-id="${quest.id}">
                        <div class="quest-header">
                            <div class="quest-icon">${icon}</div>
                            <div class="quest-title">${quest.title}</div>
                        </div>
                        <div class="quest-progress">
                            <div class="progress-bar" role="progressbar" 
                                 aria-valuenow="${progress}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="${target}"
                                 aria-label="Progress: ${progress} of ${target} ${quest.unit}">
                                <div class="progress-fill ${this.getProgressClass(status, percentage)}" 
                                     style="width: ${percentage}%"></div>
                            </div>
                            <div class="progress-text">
                                <span>${progress} / ${target} ${quest.unit}</span>
                                <span class="progress-percentage">${percentage}%</span>
                            </div>
                        </div>
                        <div class="quest-status">
                            <div class="status-indicator ${statusClass}"></div>
                            <span>${statusText}</span>
                        </div>
                    </div>
                `;
            }

            getQuestIcon(questId) {
                const icons = {
                    'connect_5': '👥',
                    'taps_25': '📱',
                    'streak_3': '🔥'
                };
                return icons[questId] || '🎯';
            }

            getQuestStatusText(status, progress, target) {
                switch (status) {
                    case 'completed':
                        return 'Completed!';
                    case 'nearly-done':
                        return 'Almost there!';
                    case 'active':
                        return target === 0 ? 'Ready to start' : 'In progress';
                    default:
                        return 'In progress';
                }
            }

            getQuestStatusClass(status) {
                switch (status) {
                    case 'completed':
                        return 'completed';
                    case 'nearly-done':
                        return 'nearly-done';
                    case 'active':
                        return 'active';
                    default:
                        return 'active';
                }
            }

            getProgressClass(status, percentage) {
                if (status === 'completed') return 'completed';
                if (percentage > 100) return 'over-achieved';
                return '';
            }

            updateQuestsWeekInfo(week) {
                const weekInfo = document.getElementById('quests-week-info');
                if (week && week.year && week.iso_week) {
                    weekInfo.textContent = `Week ${week.iso_week}, ${week.year} (server week UTC, shown in your local time)`;
                } else {
                    weekInfo.textContent = 'Current week';
                }
            }

            renderQuestsEmpty() {
                const content = document.getElementById('quests-content');
                content.innerHTML = `
                    <div class="empty-state">
                        <div>🎯</div>
                        <div>No quests available</div>
                        <div style="font-size: var(--text-sm); margin-top: var(--space-2);">
                            Check back later for new challenges
                        </div>
                    </div>
                `;
            }

            renderQuestsError(error) {
                const content = document.getElementById('quests-content');
                content.innerHTML = `
                    <div class="error-state">
                        <div>❌</div>
                        <div>Failed to load quests</div>
                        <div style="font-size: var(--text-sm); margin-top: var(--space-2);">
                            ${error.message}
                        </div>
                        <button class="retry-button" onclick="location.reload()">
                            Retry
                        </button>
                    </div>
                `;
            }

            setupQuestsRefresh() {
                const refreshButton = document.getElementById('quests-refresh-button');
                if (refreshButton) {
                    refreshButton.onclick = () => this.refreshQuests();
                }
            }

            async refreshQuests() {
                const refreshButton = document.getElementById('quests-refresh-button');
                if (refreshButton) {
                    refreshButton.disabled = true;
                    refreshButton.textContent = '⟳';
                }
                
                try {
                    await this.loadQuests();
                } finally {
                    if (refreshButton) {
                        setTimeout(() => {
                            refreshButton.disabled = false;
                            refreshButton.textContent = '↻';
                        }, 1000);
                    }
                }
            }

            loadRadar() {
                console.log('📡 [Radar] Loading radar data...');
                // TODO: Implement radar loading
            }

            loadHealth() {
                console.log('🏥 [Health] Loading health data...');
                // TODO: Implement health loading
            }
        }

        // Initialize the community page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new CommunityPage();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARC Unified Visualization</title>
    
    <style>
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --fg-primary: #ffffff;
            --fg-secondary: #cccccc;
            --fg-muted: #888888;
            --accent: #007bff;
            --accent-hover: #0056b3;
            --stroke: #333333;
            --radius: 8px;
            --radius-2: 4px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--fg-primary);
            overflow: hidden;
            height: 100vh;
        }

        .main-container {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-container {
            text-align: center;
        }

        .phone-input-container {
            margin-bottom: 24px;
        }

        .phone-input, .sms-input {
            width: 100%;
            min-width: 280px;
            max-width: 280px;
            padding: 16px;
            font-size: 1.1rem;
            background: #000000;
            border: 1px solid var(--stroke);
            border-radius: var(--radius-2);
            color: var(--fg-primary);
            text-align: center;
            letter-spacing: 1px;
            box-sizing: border-box;
        }

        .phone-input:focus, .sms-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .phone-input::placeholder, .sms-input::placeholder {
            color: var(--fg-muted);
            font-size: 1.1rem;
        }


        .resend-text {
            margin-top: 12px;
            font-size: 0.9rem;
            color: var(--fg-muted);
            cursor: pointer;
            text-decoration: underline;
        }

        .resend-text:hover {
            color: var(--fg-secondary);
        }

        .resend-text.disabled {
            color: var(--fg-muted);
            cursor: not-allowed;
            text-decoration: none;
        }

        .login-button {
            background: #000000;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--fg);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            min-width: 100px;
        }

        .login-button:hover {
            background: rgba(40, 40, 40, 0.9);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .login-button:disabled {
            background: var(--fg-muted);
            cursor: not-allowed;
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.9rem;
            margin-top: 16px;
            min-height: 20px;
        }

        .success-message {
            color: var(--fg-primary);
            font-size: 0.9rem;
            margin-top: 16px;
            min-height: 20px;
        }

        /* View Toggle Buttons */
        .view-toggle {
            position: absolute;
            top: 20px;
            left: 400px; /* Move to the right of the control panel (320px + 80px padding) */
            z-index: 1000;
            display: flex;
            background: var(--stroke);
            border-radius: var(--radius-2);
            padding: 4px;
            gap: 4px;
        }

        .nav-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--fg-muted);
            border-radius: var(--radius-2);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .nav-btn.active {
            background: var(--fg-primary);
            color: var(--bg-primary);
        }

        .nav-btn:hover:not(.active) {
            background: var(--bg-tertiary);
            color: var(--fg-primary);
        }

        /* Iframe Container */
        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            display: none;
        }

        .iframe-container.active {
            display: block;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 99999;
        }

        .loading-progress-container {
            width: 200px;
            height: 8px;
            background-color: #000000;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .loading-progress-bar {
            height: 100%;
            background-color: #ffffff;
            border-radius: 4px;
            width: 0%;
            animation: fillProgress 2.8s ease-out forwards;
        }

        @keyframes fillProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .loading-content {
            text-align: center;
        }

        .loading-content h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
            color: var(--text-primary);
        }

        .loading-content p {
            margin: 0;
            font-size: 16px;
            color: var(--text-secondary);
        }

        .loading-text {
            color: var(--fg-secondary);
            font-size: 16px;
        }

        /* Hide loading screen when content is loaded */
        .loaded .loading-screen {
            display: none;
        }
        
        /* Iframe context adjustments for mobile controls */
        @media (max-width: 900px) {
            body.iframe-context .mobile-hamburger {
                top: 10px !important;
                z-index: 10000 !important;
            }
            
            body.iframe-context .view-toggle {
                top: 10px !important;
                z-index: 10000 !important;
            }
        }

        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */
        
        /* Mobile View Toggle Positioning */
        @media (max-width: 900px) {
            .view-toggle {
                position: fixed !important;
                top: 27px !important;
                left: 40% !important;
                transform: translateX(-50%) !important;
                right: auto !important;
                z-index: 1001 !important;
            }
        }
        
        /* Extra small screens (iPhone mini) - keep same alignment */
        @media (max-width: 400px) {
            .view-toggle {
                top: 27px !important;
                left: 40% !important;
            }
        }
        
        /* Hide view toggle when control panel is open */
        .view-toggle.hidden {
            display: none;
        }
        
        /* Intermediate screen sizes - override CSS Grid layout */
        @media (min-width: 380px) and (max-width: 900px) {
            .main-container {
                display: flex !important;
                flex-direction: row !important;
            }
            
            .sidebar:not(.show) {
                width: clamp(200px, 30vw, 300px) !important;
                min-width: 200px !important;
                overflow: auto !important;
            }
            
            .sidebar.show {
                width: 100% !important;
                min-width: 100% !important;
            }
            
            .content-area {
                flex: 1 !important;
                width: 100% !important;
            }
        }

    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay" class="login-overlay hidden">
        <div class="login-container">
            <!-- Phone Entry State -->
            <div id="phoneEntryState">
                <div class="phone-input-container">
                    <input 
                        type="tel" 
                        id="phoneInput" 
                        class="phone-input" 
                        placeholder="(555) 123-4567"
                        maxlength="14"
                    >
                </div>
                
                <button id="loginButton" class="login-button" onclick="handleLogin()">
                    Enter
                </button>
            </div>

            <!-- SMS Code Entry State -->
            <div id="smsEntryState" style="display: none;">
                <div class="phone-input-container">
                    <input 
                        type="tel" 
                        id="smsInput" 
                        class="phone-input" 
                        placeholder="Enter SMS code"
                        maxlength="8"
                    >
                </div>
                
                <button id="smsButton" class="login-button" onclick="handleSMSVerification()">
                    Enter
                </button>
                
                <div id="resendText" class="resend-text" onclick="resendSMS()">
                    Resend SMS
                </div>
            </div>
            
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>
        </div>
    </div>


    <!-- Main Container -->
    <div class="main-container">
        <!-- Content Area -->
        <div class="content-area">
            <!-- View Toggle Buttons -->
            <div class="view-toggle">
                <button class="nav-btn active" id="mapBtn" onclick="switchView('map')">Map</button>
                <button class="nav-btn" id="networkBtn" onclick="switchView('network')">Graph</button>
            </div>
            
            <!-- Map View Iframe -->
            <iframe id="mapFrame" class="iframe-container active" src="8th_bedrock_map_user.html"></iframe>
            
            <!-- Network View Iframe -->
            <iframe id="networkFrame" class="iframe-container" src="10th_bedrock_network_user.html?t=1757223100"></iframe>
        </div>
    </div>

    <script>
        // ========================================
        // FEATURE FLAGS - Easy to toggle features
        // ========================================
        const ENABLE_SMS_VERIFICATION = false; // Set to true to enable Twilio SMS verification
        
        // Global variables
        let currentView = 'map';
        let mapFrame = null;
        let networkFrame = null;
        let userData = null;
        let authenticatedUser = null;

        // Format from a raw digits string (no side-effects on caret)
        function formatFromDigits(digits) {
            const d = digits.slice(0, 10);
            if (d.length >= 7) {
                return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
            } else if (d.length >= 4) {
                return `(${d.slice(0,3)}) ${d.slice(3)}`;
            } else if (d.length >= 1) {
                return `(${d}`;
            }
            return "";
        }

        // Helper: count digits in a string slice
        function countDigits(str) {
            const m = str.match(/\d/g);
            return m ? m.length : 0;
        }

        // Helper: given a formatted string and a target digit index,
        // return the caret position right after that digit index
        function caretPosForDigitIndex(formatted, digitIndex) {
            if (digitIndex <= 0) return 0;
            let idx = 0;
            let seen = 0;
            while (idx < formatted.length) {
                if (/\d/.test(formatted[idx])) {
                    seen++;
                    if (seen === digitIndex) {
                        // place caret *after* this digit
                        return idx + 1;
                    }
                }
                idx++;
            }
            // if we ran out, put caret at end
            return formatted.length;
        }

        function setupPhoneInput() {
            const el = document.getElementById('phoneInput');
            if (!el) return;

            // Initialize dataset storage
            el.dataset.prev = el.value || "";

            // Skip over formatting chars on Backspace/Delete
            el.addEventListener('keydown', function(e) {
                const val = el.value;
                const start = el.selectionStart;
                const end = el.selectionEnd;

                // If there's a selection, let input handler deal with it
                if (start !== end) return;

                // Backspace: if just after a non-digit, jump left over it
                if (e.key === 'Backspace' && start > 0 && /\D/.test(val[start - 1])) {
                    e.preventDefault();
                    const newPos = start - 1;
                    el.setSelectionRange(newPos, newPos);
                }

                // Delete: if on a non-digit, jump right over it
                if (e.key === 'Delete' && start < val.length && /\D/.test(val[start])) {
                    e.preventDefault();
                    const newPos = start + 1;
                    el.setSelectionRange(newPos, newPos);
                }

                // Enter still triggers login
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleLogin();
                }
            });

            // Reformat while preserving caret via "digit index" logic
            el.addEventListener('input', function(e) {
                const prevFormatted = el.dataset.prev || "";
                const curFormatted = el.value;

                // How many digits were before the caret in the *previous* string?
                const caret = el.selectionStart || 0;
                const prevDigitsBeforeCaret = countDigits(prevFormatted.slice(0, caret));

                // Recompute digits from current raw input
                const rawDigits = curFormatted.replace(/\D/g, '').slice(0, 10);
                const nextFormatted = formatFromDigits(rawDigits);

                // Set new value
                el.value = nextFormatted;

                // If we're adding digits (typing), position cursor after the new digit
                // If we're removing digits (deleting), maintain the same digit position
                const prevDigits = prevFormatted.replace(/\D/g, '');
                let targetDigitIndex;
                
                if (rawDigits.length > prevDigits.length) {
                    // Typing: position after the newly added digit
                    targetDigitIndex = rawDigits.length;
                } else {
                    // Deleting: maintain same digit position
                    targetDigitIndex = Math.min(prevDigitsBeforeCaret, rawDigits.length);
                }
                
                const newCaret = caretPosForDigitIndex(nextFormatted, targetDigitIndex);
                el.setSelectionRange(newCaret, newCaret);

                // Cache for next event
                el.dataset.prev = nextFormatted;
            });
        }

        // Setup SMS input with Enter key support
        function setupSMSInput() {
            const el = document.getElementById('smsInput');
            if (!el) return;

            el.addEventListener('keydown', function(e) {
                // Enter triggers SMS verification
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSMSVerification();
                }
            });
        }

        // Load user data from dynamic API (same as visualizations)
        async function loadUserData() {
            try {
                const response = await fetch('/api/data?t=' + Date.now());
                if (!response.ok) {
                    throw new Error('Failed to load user data');
                }
                const apiData = await response.json();
                
                // Normalize API data to match expected format
                userData = {
                    tap_data: apiData.taps || apiData.tap_data || [],
                    user_profiles: apiData.users || apiData.user_profiles || []
                };
                
                console.log('✅ User data loaded from API:', userData.tap_data.length, 'taps');
            } catch (error) {
                console.error('❌ Error loading user data:', error);
                showError('Failed to load user data. Please refresh the page.');
            }
        }

        // Find user by phone number
        function findUserByPhone(phoneNumber) {
            if (!userData || !userData.tap_data) {
                return null;
            }

            // Clean phone number for comparison
            const cleanPhone = phoneNumber.replace(/\D/g, '');
            
            // Search for user with matching phone number in tap_data
            for (const tap of userData.tap_data) {
                // Check user1
                if (tap.user1_phone_number) {
                    const user1Phone = tap.user1_phone_number.replace(/\D/g, '');
                    if (user1Phone === cleanPhone) {
                        return {
                            user_id: tap.user1_id,
                            name: tap.user1_name,
                            username: tap.user1_username,
                            phone_number: tap.user1_phone_number,
                            tap_count: tap.user1_tap_count,
                            connections_count: tap.user1_connections_count
                        };
                    }
                }
                
                // Check user2
                if (tap.user2_phone_number) {
                    const user2Phone = tap.user2_phone_number.replace(/\D/g, '');
                    if (user2Phone === cleanPhone) {
                        return {
                            user_id: tap.user2_id,
                            name: tap.user2_name,
                            username: tap.user2_username,
                            phone_number: tap.user2_phone_number,
                            tap_count: tap.user2_tap_count,
                            connections_count: tap.user2_connections_count
                        };
                    }
                }
            }

            return null;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            errorDiv.textContent = message;
            successDiv.textContent = '';
        }

        // Show success message
        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            errorDiv.textContent = '';
            successDiv.textContent = message;
        }

        // Clear messages
        function clearMessages() {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            errorDiv.textContent = '';
            successDiv.textContent = '';
        }

        // Global variables for SMS flow
        let currentPhoneNumber = '';
        let resendCooldown = 0;

        // Handle login - now sends SMS instead of direct authentication
        async function handleLogin() {
            const phoneInput = document.getElementById('phoneInput');
            const loginButton = document.getElementById('loginButton');
            const phoneNumber = phoneInput.value.trim();

            // Clear previous messages
            clearMessages();

            // Validate phone number format
            if (!phoneNumber) {
                showError('Please enter your phone number');
                return;
            }

            const cleanPhone = phoneNumber.replace(/\D/g, '');
            if (cleanPhone.length !== 10) {
                showError('Please enter a valid 10-digit phone number');
                return;
            }

            // Disable button during processing
            loginButton.disabled = true;
            loginButton.textContent = 'Processing...';

            try {
                // Add +1 prefix to the phone number
                const fullPhoneNumber = '+1' + cleanPhone;
                currentPhoneNumber = fullPhoneNumber;
                
                if (ENABLE_SMS_VERIFICATION) {
                    // Send SMS via our API
                    const response = await fetch('/api/auth/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ phone: fullPhoneNumber })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.ok) {
                        // SMS sent successfully - switch to SMS entry state
                        showSMSEntryState();
                        showSuccess('SMS sent! Check your phone for the verification code.');
                    } else {
                        showError('Failed to send SMS. Please try again.');
                    }
                } else {
                    // Skip SMS verification - authenticate directly
                    console.log('🔓 SMS verification disabled - authenticating directly');
                    await authenticateUser();
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('An error occurred. Please try again.');
            } finally {
                // Re-enable button
                loginButton.disabled = false;
                loginButton.textContent = 'Enter';
            }
        }

        // Handle SMS verification
        async function handleSMSVerification() {
            const smsInput = document.getElementById('smsInput');
            const smsButton = document.getElementById('smsButton');
            const code = smsInput.value.trim();

            // Clear previous messages
            clearMessages();

            // Validate SMS code format
            if (!/^\d{4,8}$/.test(code)) {
                showError('Please enter a valid SMS code');
                return;
            }

            // Disable button during verification
            smsButton.disabled = true;
            smsButton.textContent = 'Verifying...';

            try {
                // Verify SMS code via our API
                const response = await fetch('/api/auth/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: currentPhoneNumber, code: code })
                });
                
                const result = await response.json();
                
                if (response.ok && result.ok) {
                    // SMS verified successfully - proceed with authentication
                    await authenticateUser();
                } else {
                    showError('Invalid or expired code. Please try again.');
                }
            } catch (error) {
                console.error('SMS verification error:', error);
                showError('An error occurred. Please try again.');
            } finally {
                // Re-enable button
                smsButton.disabled = false;
                smsButton.textContent = 'Enter';
            }
        }

        // Authenticate user after SMS verification
        async function authenticateUser() {
            try {
                // Find user by phone number
                const user = findUserByPhone(currentPhoneNumber);
                
                if (user) {
                    // User found - authenticate
                    authenticatedUser = user;
                    const userName = user.name;
                    showSuccess(`Welcome, ${userName}!`);
                    
                    // Store in sessionStorage for persistence
                    sessionStorage.setItem('authenticatedUser', JSON.stringify(user));
                    
                    // Show loading screen immediately
                    showLoadingScreen();
                    
                    // Hide login overlay after brief delay
                    setTimeout(() => {
                        hideLoginOverlay();
                        // Pass user ID and name to bedrocks
                        passUserToBedrocks(user.user_id, user.name);
                    }, 500);
                } else {
                    // User not found
                    showError('No account found for this phone number');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showError('An error occurred during authentication.');
            }
        }

        // Show SMS entry state
        function showSMSEntryState() {
            document.getElementById('phoneEntryState').style.display = 'none';
            document.getElementById('smsEntryState').style.display = 'block';
            
            // Focus on SMS input
            setTimeout(() => {
                document.getElementById('smsInput').focus();
            }, 100);
            
            // Start resend cooldown
            startResendCooldown();
        }

        // Resend SMS
        async function resendSMS() {
            if (resendCooldown > 0) return;
            
            const resendText = document.getElementById('resendText');
            resendText.classList.add('disabled');
            resendText.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/auth/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ phone: currentPhoneNumber })
                });
                
                const result = await response.json();
                
                if (response.ok && result.ok) {
                    showSuccess('SMS resent! Check your phone.');
                    startResendCooldown();
                } else {
                    showError('Failed to resend SMS. Please try again.');
                }
            } catch (error) {
                console.error('Resend SMS error:', error);
                showError('Failed to resend SMS. Please try again.');
            }
        }

        // Start resend cooldown timer
        function startResendCooldown() {
            resendCooldown = 30; // 30 seconds
            const resendText = document.getElementById('resendText');
            
            const timer = setInterval(() => {
                if (resendCooldown > 0) {
                    resendText.textContent = `Resend SMS (${resendCooldown}s)`;
                    resendCooldown--;
                } else {
                    resendText.textContent = 'Resend SMS';
                    resendText.classList.remove('disabled');
                    clearInterval(timer);
                }
            }, 1000);
        }

        // Hide login overlay
        function hideLoginOverlay() {
            const loginOverlay = document.getElementById('loginOverlay');
            loginOverlay.classList.add('hidden');
        }

        // Show loading screen
        function showLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'flex';
                loadingScreen.innerHTML = `
                    <div class="loading-progress-container">
                        <div class="loading-progress-bar"></div>
                    </div>
                `;
            }
        }

        // Hide loading screen
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
        }
        

        // Pass user ID to bedrocks via URL parameters
        function passUserToBedrocks(userId, userName) {
            
            // Ensure iframes are initialized
            if (!mapFrame || !networkFrame) {
                mapFrame = document.getElementById('mapFrame');
                networkFrame = document.getElementById('networkFrame');
            }
            
            // Load both iframes simultaneously
            const mapUrl = `8th_bedrock_map_user.html?userName=${encodeURIComponent(userName)}&t=${Date.now()}`;
            const networkUrl = `10th_bedrock_network_user.html?userName=${encodeURIComponent(userName)}&t=${Date.now()}`;
            
            
            // Track which iframe is the currently visible one
            let visibleIframeLoaded = false;
            let hiddenIframeLoaded = false;
            
            // Function to check if we should hide loading screen
            function checkLoadingComplete() {
                if (visibleIframeLoaded && hiddenIframeLoaded) {
                    setTimeout(() => {
                        hideLoadingScreen();
                    }, 2800); // Give more time for the auto-selection to complete
                }
            }
            
            // Set up load listeners for both iframes
            if (mapFrame) {
                mapFrame.onload = function() {
                    if (currentView === 'map') {
                        visibleIframeLoaded = true;
                    } else {
                        hiddenIframeLoaded = true;
                    }
                    checkLoadingComplete();
                };
                mapFrame.src = mapUrl;
            }
            
            if (networkFrame) {
                networkFrame.onload = function() {
                    if (currentView === 'network') {
                        visibleIframeLoaded = true;
                    } else {
                        hiddenIframeLoaded = true;
                    }
                    checkLoadingComplete();
                };
                networkFrame.src = networkUrl;
            }
            
            // Initialize bedrocks after setting user name
            initializeBedrocks();
        }

        // Check for existing authentication
        function checkExistingAuth() {
            const storedUser = sessionStorage.getItem('authenticatedUser');
            if (storedUser) {
                try {
                    authenticatedUser = JSON.parse(storedUser);
                    const userName = authenticatedUser.name;
                    
                    // Skip login overlay and go straight to loading screen
                    hideLoginOverlay();
                    showLoadingScreen();
                    passUserToBedrocks(authenticatedUser.user_id, authenticatedUser.name);
                    return true;
                } catch (error) {
                    console.error('Error parsing stored user:', error);
                    sessionStorage.removeItem('authenticatedUser');
                }
            }
            return false;
        }

        // Initialize the application
        async function init() {
            
            // Load user data
            await loadUserData();
            
            // Setup phone input formatting
            setupPhoneInput();
            
            // Setup SMS input (only if SMS verification is enabled)
            if (ENABLE_SMS_VERIFICATION) {
                setupSMSInput();
            }
            
            // Check for existing authentication
            if (checkExistingAuth()) {
                // User is already authenticated, continue with normal initialization
                initializeBedrocks();
            } else {
                // Show login overlay
                const loginOverlay = document.getElementById('loginOverlay');
                if (loginOverlay) {
                    loginOverlay.classList.remove('hidden');
                }
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.style.display = 'none';
                }
            }
        }

        // Initialize bedrocks after authentication
        function initializeBedrocks() {
            // Get iframe references
            mapFrame = document.getElementById('mapFrame');
            networkFrame = document.getElementById('networkFrame');
            
            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');
            
            if (viewParam === 'map' || viewParam === 'network') {
                currentView = viewParam;
            }
            
            // Update navigation
            updateNavigation();
            
            // Switch to the correct view
            switchViewContent();
            
            // Hide loading screen after a short delay
            setTimeout(() => {
                document.body.classList.add('loaded');
            }, 1000);
        }

        // Switch between views
        function switchView(view) {
            if (view === currentView) return;
            
            // Update current view
            currentView = view;
            
            // Update navigation
            updateNavigation();
            
            // Update URL
            updateURL();
            
            // Switch view content
            switchViewContent();
        }

        // Update navigation buttons
        function updateNavigation() {
            const mapBtn = document.getElementById('mapBtn');
            const networkBtn = document.getElementById('networkBtn');
            
            mapBtn.classList.toggle('active', currentView === 'map');
            networkBtn.classList.toggle('active', currentView === 'network');
        }

        // Update URL
        function updateURL() {
            const url = new URL(window.location);
            url.searchParams.set('view', currentView);
            window.history.pushState({}, '', url);
        }

        // Switch view content
        function switchViewContent() {
            try {
                // Hide all iframes
                mapFrame.classList.remove('active');
                networkFrame.classList.remove('active');

                // Show the active iframe
                if (currentView === 'map') {
                    mapFrame.classList.add('active');
                } else {
                    // For network view, check if this is the first time loading
                    if (window.networkGraphLoaded) {
                        networkFrame.classList.add('active');
                        
                        // Trigger resize event to ensure proper rendering
                        if (networkFrame.contentWindow) {
                            networkFrame.contentWindow.dispatchEvent(new Event('resize'));
                        }
                    } else {
                        // Show loading screen for first-time load
                        const loadingScreen = document.getElementById('loadingScreen');
                        if (loadingScreen) {
                            loadingScreen.style.display = 'flex';
                        }
                        
                        // Reload the network iframe (necessary for vis.js to render properly)
                        const userName = authenticatedUser ? authenticatedUser.name : 'Unknown User';
                        const networkUrl = `10th_bedrock_network_user.html?userName=${encodeURIComponent(userName)}&t=${Date.now()}`;
                        
                        networkFrame.src = '';
                        setTimeout(() => {
                            networkFrame.src = networkUrl;
                            networkFrame.classList.add('active');
                            
                            // Set flag to indicate network has been loaded
                            window.networkGraphLoaded = true;
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error in switchViewContent:', error);
            }
        }

        // Handle browser back/forward
        window.addEventListener('popstate', function(event) {
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');
            if (viewParam && viewParam !== currentView) {
                switchView(viewParam);
            }
        });


        // ========================================
        // MOBILE VIEW TOGGLE VISIBILITY CONTROL
        // ========================================
        
        // Function to hide view toggle when control panel is open
        function hideViewToggle() {
            const viewToggle = document.querySelector('.view-toggle');
            if (viewToggle) {
                viewToggle.classList.add('hidden');
            }
        }
        
        // Function to show view toggle when control panel is closed
        function showViewToggle() {
            const viewToggle = document.querySelector('.view-toggle');
            if (viewToggle) {
                viewToggle.classList.remove('hidden');
            }
        }
        
        // Listen for iframe messages about control panel state
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'controlPanelState') {
                if (event.data.isOpen) {
                    hideViewToggle();
                } else {
                    showViewToggle();
                }
            }
        });

        // Detect iframe context and add class for mobile adjustments
        function detectIframeContext() {
            if (window !== window.top) {
                document.body.classList.add('iframe-context');
                console.log('🔗 Iframe context detected - applying mobile control adjustments');
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            detectIframeContext();
            // Fix mobile view toggle positioning immediately
            fixMobileViewTogglePosition();
            init();
        });
        
        // Function to fix mobile view toggle positioning
        function fixMobileViewTogglePosition() {
            const viewToggle = document.querySelector('.view-toggle');
            if (viewToggle && window.innerWidth <= 900) {
                // Force mobile positioning immediately
                viewToggle.style.position = 'fixed';
                viewToggle.style.top = '27px';
                viewToggle.style.left = '40%';
                viewToggle.style.transform = 'translateX(-50%)';
                viewToggle.style.right = 'auto';
                viewToggle.style.zIndex = '1001';
            }
        }
    </script>
</body>
</html>
<!-- Develop branch test -->
<!-- Force Vercel deployment -->
